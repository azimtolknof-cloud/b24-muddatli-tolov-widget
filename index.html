<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MUDDATLI TO'LOV</title>

  <!-- Bitrix24 JS SDK -->
  <script src="https://api.bitrix24.com/api/v1/"></script>

  <!-- FullCalendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --line:#e7eaf0;
      --text:#1f2937;
      --muted:#6b7280;

      --green:#22c55e;
      --yellow:#f59e0b;
      --red:#ef4444;

      --btn:#2563eb;
      --btnText:#fff;
    }

    html, body { height:100%; }
    body{ margin:0; font-family: Arial, sans-serif; background: var(--bg); color: var(--text); }

    .topbar{
      display:flex; align-items:center; gap:10px;
      padding:12px; background: var(--card);
      border-bottom:1px solid var(--line);
      position: sticky; top:0; z-index: 10;
    }
    .btn{
      border:1px solid #cfd6e3; background:#fff;
      padding:8px 12px; border-radius:8px;
      cursor:pointer; font-weight:700;
    }
    .btn.primary{ background: var(--btn); color: var(--btnText); border-color: var(--btn); }
    .btn:active{ transform: translateY(1px); }

    .status{ margin-left:6px; color: var(--muted); font-size: 13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .wrap{
      padding: 12px;
      display:grid;
      grid-template-columns: 1fr 380px;
      gap: 12px;
    }

    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      box-sizing: border-box;
    }

    #calendar{ min-height: 620px; }

    .analytics h3{ margin: 0 0 10px 0; font-size: 16px; }
    .kpi{ display:grid; grid-template-columns: 1fr; gap:10px; }

    .kpiRow{
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
    }
    .kpiRow .label{
      display:flex; align-items:center; justify-content:space-between;
      font-size: 13px; color: var(--muted); margin-bottom: 6px;
      font-weight: 700;
    }
    .kpiRow .value{ font-size: 18px; font-weight: 900; }

    .barline{ height: 8px; background:#eef2ff; border-radius: 999px; overflow:hidden; margin-top:8px; }
    .barfill{ height:100%; width:0%; }

    .help{ font-size: 12px; color: var(--muted); margin-top: 10px; line-height: 1.4; }
    .err{ margin-top: 10px; color:#b91c1c; white-space: pre-wrap; font-size: 13px; }

    /* Modal */
    .modalMask{
      position: fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none; align-items:center; justify-content:center;
      z-index: 999999; padding: 16px; box-sizing: border-box;
    }
    .modal{
      width: min(900px, 100%);
      background: var(--card);
      border-radius: 16px;
      border:1px solid var(--line);
      box-shadow: 0 30px 80px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 14px;
      border-bottom:1px solid var(--line);
      font-weight: 900;
    }
    .modalBody{ padding: 14px; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    .field label{
      display:block; font-size: 12px; color: var(--muted);
      margin-bottom: 6px; font-weight: 800;
    }
    .field input{
      width:100%;
      padding: 10px 10px;
      border-radius: 10px;
      border:1px solid #cfd6e3;
      outline:none; box-sizing: border-box;
    }
    .modalFoot{
      padding: 12px 14px;
      border-top:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .leftTools{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .rightTools{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    /* Calendar event styles */
    .fc .fc-daygrid-event{
      border: none !important;
      border-radius: 10px !important;
      padding: 3px 6px !important;
      font-weight: 800;
      cursor:pointer;
    }
    .evt-green{ background: rgba(34,197,94,.18) !important; color: #065f46 !important; }
    .evt-yellow{ background: rgba(245,158,11,.20) !important; color: #92400e !important; }
    .evt-red{ background: rgba(239,68,68,.18) !important; color: #7f1d1d !important; }
  </style>
</head>

<body>
  <div class="topbar">
    <button class="btn" id="btnRefresh" type="button">Refresh</button>
    <button class="btn primary" id="btnGenerate" type="button">Generate schedule</button>
    <button class="btn" id="btnSettings" type="button">Settings</button>
    <div class="status" id="status">Loading...</div>
  </div>

  <div class="wrap">
    <div class="card">
      <div id="calendar"></div>
      <div class="help">
        Ranglar: <b style="color:var(--green)">yashil</b> = to‘langan, <b style="color:var(--yellow)">sariq</b> = muddat yaqin, <b style="color:var(--red)">qizil</b> = prosrochka.
        Event ustiga bossangiz: <b>PENDING → PAID</b> statusga o‘tadi.
      </div>
      <div class="err" id="mainErr"></div>
    </div>

    <div class="card analytics">
      <h3>Analitika</h3>
      <div class="kpi">
        <div class="kpiRow">
          <div class="label"><span>Paid</span><span id="kpiPaidPct">0%</span></div>
          <div class="value" id="kpiPaid">0 so‘m</div>
          <div class="barline"><div class="barfill" id="barPaid"></div></div>
        </div>

        <div class="kpiRow">
          <div class="label"><span>Expected</span><span id="kpiExpectedPct">0%</span></div>
          <div class="value" id="kpiExpected">0 so‘m</div>
          <div class="barline"><div class="barfill" id="barExpected"></div></div>
        </div>

        <div class="kpiRow">
          <div class="label"><span>Overdue</span><span id="kpiOverduePct">0%</span></div>
          <div class="value" id="kpiOverdue">0 so‘m</div>
          <div class="barline"><div class="barfill" id="barOverdue"></div></div>
        </div>

        <div class="kpiRow">
          <div class="label"><span>Jami</span><span id="kpiCount">0 ta</span></div>
          <div class="value" id="kpiTotal">0 so‘m</div>
          <div class="help" id="kpiHint">—</div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modalMask" id="modalMask">
    <div class="modal">
      <div class="modalHead">
        <div id="modalTitle">Modal</div>
        <button class="btn" id="btnCloseModal" type="button">Close</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFoot" id="modalFoot"></div>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const LS_KEY = "muddatli_tolov_cfg_final_v1";

  // === DEFAULT CONFIG (siz yuborgan qiymatlar bilan) ===
  const DEFAULT_CFG = {
    spaTitle: "MUDDATLI TO'LOV",
    parentField: "parentId2",
    dueField: "UF_CRM_15_1768516812",
    amountField: "UF_CRM_15_1768516945",
    instField: "UF_CRM_15_1768516987",
    stagePending: "DT1058_19:UC_9HOY6X",
    stagePaid: "DT1058_19:SUCCESS",
    nearDays: 3
  };

  let calendar = null;
  let dealId = null;
  let entityTypeId = null;
  let itemsCache = [];

  function setStatus(t){ $("status").textContent = t || ""; }
  function setMainErr(t){ $("mainErr").textContent = t || ""; }

  function moneyUZS(n){
    const x = Number(n||0);
    return x.toLocaleString("ru-RU") + " so‘m";
  }
  function onlyDigits(s){ return String(s||"").replace(/[^\d]/g,""); }

  function openModal(title, bodyHtml, footHtml){
    $("modalTitle").textContent = title;
    $("modalBody").innerHTML = bodyHtml || "";
    $("modalFoot").innerHTML = footHtml || "";
    $("modalMask").style.display = "flex";
  }
  function closeModal(){
    $("modalMask").style.display = "none";
    $("modalTitle").textContent = "";
    $("modalBody").innerHTML = "";
    $("modalFoot").innerHTML = "";
  }
  $("btnCloseModal").addEventListener("click", closeModal);
  $("modalMask").addEventListener("click", (e)=>{ if(e.target.id==="modalMask") closeModal(); });

  function loadCfg(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return { ...DEFAULT_CFG };
      return { ...DEFAULT_CFG, ...JSON.parse(raw) };
    }catch{
      return { ...DEFAULT_CFG };
    }
  }
  function saveCfg(cfg){
    localStorage.setItem(LS_KEY, JSON.stringify(cfg));
  }

  function bxCall(method, params){
    return new Promise((resolve, reject)=>{
      BX24.callMethod(method, params, function(res){
        if(res.error()){
          reject(new Error(method + ": " + res.error() + " " + (res.error_description()||"")));
          return;
        }
        resolve(res.data());
      });
    });
  }
  function normalizeToArray(data) {
  // Bitrix qaytarishi mumkin bo‘lgan formatlar:
  // 1) Array: [...]
  // 2) Object: { items: [...] }
  // 3) Object: { types: [...] }
  // 4) Object: { list: [...] } yoki boshqalar
  if (!data) return [];

  if (Array.isArray(data)) return data;

  if (typeof data === "object") {
    if (Array.isArray(data.items)) return data.items;
    if (Array.isArray(data.types)) return data.types;
    if (Array.isArray(data.list)) return data.list;

    // Ba’zan bitta elementni object qilib qaytaradi:
    // uni arrayga o‘raymiz
    return [];
  }

  return [];
}

function bxCallAll(method, params) {
  return new Promise((resolve, reject) => {
    const all = [];

    BX24.callMethod(method, params, function(res) {
      if (res.error()) {
        reject(new Error(method + ": " + res.error() + " " + (res.error_description() || "")));
        return;
      }

      const data = res.data();
      const chunk = normalizeToArray(data);

      // Mana shu joy oldin "spread" bilan yiqilayotgan edi
      for (const x of chunk) all.push(x);

      if (res.more()) {
        res.next();
      } else {
        resolve(all);
      }
    });
  });
}

  async function getDealIdFromPlacement(){
    const info = await new Promise((r)=>BX24.placement.info(r));
    const opts = info && info.options ? info.options : {};
    return Number(opts.ID || opts.id || opts.ENTITY_ID || opts.entityId || opts.DEAL_ID || 0) || null;
  }

  async function resolveEntityTypeIdByTitle(spaTitle){
    const types = await bxCallAll("crm.type.list", { order: { id:"ASC" } });
    const key = String(spaTitle||"").trim().toLowerCase();
    const found = types.find(t => String(t.title||"").trim().toLowerCase() === key);
    if(!found) throw new Error("SPA topilmadi: '"+spaTitle+"'. SPA nomini tekshiring.");
    return found.entityTypeId || found.id;
  }

  function parseISODate(d){
    if(!d) return null;
    const s = String(d).substring(0,10);
    if(!/^\d{4}-\d{2}-\d{2}$/.test(s)) return null;
    const [y,m,dd] = s.split("-").map(Number);
    const dt = new Date(y, m-1, dd);
    dt.setHours(0,0,0,0);
    return dt;
  }

  function addMonths(dateStr, add){
    const dt = parseISODate(dateStr);
    if(!dt) return null;
    const y = dt.getFullYear();
    const m = dt.getMonth();
    const d = dt.getDate();
    const tmp = new Date(y, m + add, d);
    tmp.setHours(0,0,0,0);
    const yy = tmp.getFullYear();
    const mm = String(tmp.getMonth()+1).padStart(2,"0");
    const dd = String(tmp.getDate()).padStart(2,"0");
    return `${yy}-${mm}-${dd}`;
  }

  function classify(it, cfg){
    const amt = Number(it[cfg.amountField]||0);
    const isPaid = cfg.stagePaid && it.stageId === cfg.stagePaid;
    if(isPaid) return { cls:"evt-green", bucket:"paid", amt, isPaid:true };

    const due = parseISODate(it[cfg.dueField]);
    if(!due) return { cls:"evt-yellow", bucket:"expected", amt, isPaid:false };

    const today = new Date();
    today.setHours(0,0,0,0);
    const diffDays = Math.floor((due.getTime()-today.getTime())/86400000);

    if(diffDays < 0) return { cls:"evt-red", bucket:"overdue", amt, isPaid:false };
    if(diffDays <= Number(cfg.nearDays||3)) return { cls:"evt-yellow", bucket:"expected", amt, isPaid:false };

    return { cls:"evt-yellow", bucket:"expected", amt, isPaid:false };
  }

  function updateAnalytics(items, cfg){
    let paid=0, expected=0, overdue=0, total=0, count=0;
    for(const it of items){
      const c = classify(it,cfg);
      count += 1;
      total += c.amt;
      if(c.bucket==="paid") paid += c.amt;
      else if(c.bucket==="overdue") overdue += c.amt;
      else expected += c.amt;
    }

    $("kpiPaid").textContent = moneyUZS(paid);
    $("kpiExpected").textContent = moneyUZS(expected);
    $("kpiOverdue").textContent = moneyUZS(overdue);
    $("kpiTotal").textContent = moneyUZS(total);
    $("kpiCount").textContent = count + " ta";

    const pct = (x)=> total>0 ? Math.round((x/total)*100) : 0;
    const pPaid = pct(paid), pExp=pct(expected), pOver=pct(overdue);

    $("kpiPaidPct").textContent = pPaid + "%";
    $("kpiExpectedPct").textContent = pExp + "%";
    $("kpiOverduePct").textContent = pOver + "%";

    $("barPaid").style.width = pPaid + "%";
    $("barExpected").style.width = pExp + "%";
    $("barOverdue").style.width = pOver + "%";

    $("barPaid").style.background = "var(--green)";
    $("barExpected").style.background = "var(--yellow)";
    $("barOverdue").style.background = "var(--red)";

    $("kpiHint").textContent = `Deal #${dealId}. nearDays=${cfg.nearDays}.`;
  }

  function initCalendar(){
    calendar = new FullCalendar.Calendar($("calendar"), {
      initialView: "dayGridMonth",
      height: "auto",
      headerToolbar: { left:"prev,next today", center:"title", right:"" },
      eventClick: async (info)=>{
        try{
          const cfg = loadCfg();
          const itemId = Number(info.event.id);
          const isPaid = !!(info.event.extendedProps && info.event.extendedProps.isPaid);

          if(isPaid) return; // allaqachon PAID bo‘lsa tegmaymiz

          if(!cfg.stagePaid) return alert("Settings: STAGE_PAID yo‘q");

          setStatus("Marking PAID...");
          await bxCall("crm.item.update", {
            entityTypeId,
            id: itemId,
            fields: { stageId: cfg.stagePaid }
          });

          await refreshAll();
          setStatus("Updated");
        }catch(e){
          alert(String(e.message||e));
          setStatus("");
        }
      }
    });
    calendar.render();
  }

  async function loadItemsForDeal(){
    const cfg = loadCfg();

    if(!dealId) throw new Error("Deal ID topilmadi. Widget deal ichida ochilishi shart.");
    if(!entityTypeId) entityTypeId = await resolveEntityTypeIdByTitle(cfg.spaTitle);

    const required = ["parentField","dueField","amountField","instField","stagePending","stagePaid"];
    for(const k of required){
      if(!cfg[k]) throw new Error("Settings to‘liq emas: " + k);
    }

    const filter = {};
    filter[cfg.parentField] = dealId;

    const select = ["id","title","stageId", cfg.dueField, cfg.amountField, cfg.instField];
    const items = await bxCallAll("crm.item.list", {
      entityTypeId,
      filter,
      select,
      order: { "id":"ASC" }
    });

    itemsCache = items;
    return items;
  }

  function renderCalendar(items){
    const cfg = loadCfg();
    const events = items.map(it=>{
      const due = String(it[cfg.dueField]||"").substring(0,10);
      if(!due) return null;

      const c = classify(it,cfg);
      const inst = it[cfg.instField] || "";
      const amt = Number(it[cfg.amountField]||0);

      return {
        id: String(it.id),
        title: `${inst} • ${moneyUZS(amt)}`,
        start: due,
        allDay: true,
        classNames: [c.cls],
        extendedProps: { isPaid: c.isPaid }
      };
    }).filter(Boolean);

    calendar.removeAllEvents();
    calendar.addEventSource(events);
  }

  async function refreshAll(){
    setMainErr("");
    const cfg = loadCfg();
    setStatus("Loading...");
    const items = await loadItemsForDeal();
    renderCalendar(items);
    updateAnalytics(items, cfg);
    setStatus("Loaded: " + items.length);
  }

  function openSettings(){
    const cfg = loadCfg();
    openModal(
      "Settings",
      `
        <div class="grid2">
          <div class="field">
            <label>SPA_NAME</label>
            <input id="s_spaTitle" value="${cfg.spaTitle.replace(/"/g,'&quot;')}">
          </div>
          <div class="field">
            <label>PARENT_FIELD</label>
            <input id="s_parentField" value="${cfg.parentField.replace(/"/g,'&quot;')}">
          </div>

          <div class="field">
            <label>DUE_DATE_FIELD</label>
            <input id="s_dueField" value="${cfg.dueField.replace(/"/g,'&quot;')}">
          </div>
          <div class="field">
            <label>AMOUNT_FIELD</label>
            <input id="s_amountField" value="${cfg.amountField.replace(/"/g,'&quot;')}">
          </div>

          <div class="field">
            <label>INSTALLMENT_FIELD</label>
            <input id="s_instField" value="${cfg.instField.replace(/"/g,'&quot;')}">
          </div>
          <div class="field">
            <label>Sariq (yaqin) – kun</label>
            <input id="s_nearDays" type="number" min="0" value="${Number(cfg.nearDays||3)}">
          </div>

          <div class="field">
            <label>STAGE_PENDING</label>
            <input id="s_stagePending" value="${cfg.stagePending.replace(/"/g,'&quot;')}">
          </div>
          <div class="field">
            <label>STAGE_PAID</label>
            <input id="s_stagePaid" value="${cfg.stagePaid.replace(/"/g,'&quot;')}">
          </div>
        </div>

        <div class="help">
          Siz yuborgan qiymatlar allaqachon default sifatida turibdi. Kerak bo‘lsa shu yerdan o‘zgartirib Save qiling.
        </div>

        <div class="err" id="s_err"></div>
      `,
      `
        <div class="leftTools">
          <button class="btn" id="s_reset" type="button">Reset defaults</button>
        </div>
        <div class="rightTools">
          <button class="btn" id="s_cancel" type="button">Cancel</button>
          <button class="btn primary" id="s_save" type="button">Save</button>
        </div>
      `
    );

    $("s_cancel").onclick = closeModal;

    $("s_reset").onclick = async ()=>{
      try{
        saveCfg({ ...DEFAULT_CFG });
        entityTypeId = null;
        closeModal();
        await refreshAll();
      }catch(e){
        $("s_err").textContent = String(e.message||e);
      }
    };

    $("s_save").onclick = async ()=>{
      try{
        const next = {
          spaTitle: $("s_spaTitle").value.trim(),
          parentField: $("s_parentField").value.trim(),
          dueField: $("s_dueField").value.trim(),
          amountField: $("s_amountField").value.trim(),
          instField: $("s_instField").value.trim(),
          stagePending: $("s_stagePending").value.trim(),
          stagePaid: $("s_stagePaid").value.trim(),
          nearDays: Number($("s_nearDays").value || 3)
        };

        for(const k of ["spaTitle","parentField","dueField","amountField","instField","stagePending","stagePaid"]){
          if(!next[k]) throw new Error("Bo‘sh qoldi: " + k);
        }

        saveCfg(next);
        entityTypeId = null; // qayta topilsin
        closeModal();
        await refreshAll();
      }catch(e){
        $("s_err").textContent = String(e.message||e);
      }
    };
  }

  function openGenerate(){
    const cfg = loadCfg();
    const today = new Date();
    const y = today.getFullYear();
    const m = String(today.getMonth()+1).padStart(2,"0");
    const d = String(today.getDate()).padStart(2,"0");
    const defaultDate = `${y}-${m}-${d}`;

    openModal(
      "Generate schedule",
      `
        <div class="grid2">
          <div class="field">
            <label>Months</label>
            <input id="g_months" type="number" min="1" value="12">
          </div>
          <div class="field">
            <label>Start date</label>
            <input id="g_start" type="date" value="${defaultDate}">
          </div>

          <div class="field">
            <label>Total amount (so‘m)</label>
            <input id="g_total" inputmode="numeric" placeholder="10000000">
          </div>
          <div class="field">
            <label>Har oy (auto)</label>
            <input id="g_perMonth" disabled value="0 so‘m">
          </div>
        </div>

        <div class="help">
          Create bosilganda: har oy uchun SPA item yaratiladi (Deal #${dealId} ga bog‘lanadi).<br>
          Summalar: so‘m formatda; oxirgi oyga remainder qo‘shiladi.
        </div>

        <div class="err" id="g_err"></div>
      `,
      `
        <div class="leftTools">
          <button class="btn" id="g_cancel" type="button">Cancel</button>
        </div>
        <div class="rightTools">
          <button class="btn primary" id="g_create" type="button">Create</button>
        </div>
      `
    );

    function recalc(){
      const months = Number($("g_months").value||0);
      const total = Number(onlyDigits($("g_total").value)||0);
      if(months>0 && total>0){
        $("g_perMonth").value = moneyUZS(Math.floor(total/months));
      }else{
        $("g_perMonth").value = "0 so‘m";
      }
    }

    $("g_total").addEventListener("input", ()=>{
      const v = onlyDigits($("g_total").value);
      $("g_total").value = v ? v : "";
      recalc();
    });
    $("g_months").addEventListener("input", recalc);

    $("g_cancel").onclick = closeModal;

    $("g_create").onclick = async ()=>{
      try{
        $("g_err").textContent = "";
        const cfg2 = loadCfg();

        const months = Number($("g_months").value||0);
        const start = $("g_start").value;
        const total = Number(onlyDigits($("g_total").value)||0);

        if(!(months>=1)) throw new Error("Months noto‘g‘ri.");
        if(!/^\d{4}-\d{2}-\d{2}$/.test(start)) throw new Error("Start date noto‘g‘ri.");
        if(!(total>0)) throw new Error("Total amount noto‘g‘ri.");

        if(!entityTypeId) entityTypeId = await resolveEntityTypeIdByTitle(cfg2.spaTitle);

        const per = Math.floor(total/months);
        const rem = total - per*months;

        setStatus("Creating items...");
        // yaratishda barqaror: ketma-ket
        for(let i=1;i<=months;i++){
          const due = addMonths(start, i-1);
          const amt = per + (i===months ? rem : 0);
          const inst = `${i}/${months}`;

          const fields = {};
          fields[cfg2.dueField] = due;
          fields[cfg2.amountField] = amt;
          fields[cfg2.instField] = inst;
          fields.stageId = cfg2.stagePending;
          fields[cfg2.parentField] = dealId;

          await bxCall("crm.item.add", { entityTypeId, fields });
        }

        closeModal();
        await refreshAll();
        setStatus("Created: " + months);
      }catch(e){
        $("g_err").textContent = String(e.message||e);
        setStatus("");
      }
    };

    recalc();
  }

  // UI buttons
  $("btnSettings").addEventListener("click", openSettings);
  $("btnGenerate").addEventListener("click", openGenerate);
  $("btnRefresh").addEventListener("click", async ()=>{
    try{ await refreshAll(); }catch(e){ alert(String(e.message||e)); }
  });

  // Boot
  BX24.init(async function(){
    try{
      initCalendar();
      dealId = await getDealIdFromPlacement();
      if(!dealId) throw new Error("Deal ID olinmadi. Widget faqat Deal ichida ishlaydi.");
      await refreshAll();
    }catch(e){
      setMainErr(String(e.message||e));
      setStatus("Error");
    }
  });

})();
</script>

</body>
</html>
