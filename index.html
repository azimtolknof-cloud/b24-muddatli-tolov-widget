<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MUDDATLI TO'LOV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bitrix24 JS -->
  <script src="https://api.bitrix24.com/api/v1/"></script>

  <!-- FullCalendar (FAqat 1 ta CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#fff;
      --border:#e6e8ee;
      --text:#111827;
      --muted:#6b7280;

      --green:#16a34a;
      --yellow:#f59e0b;
      --red:#ef4444;
      --blue:#2563eb;
    }
    body{ margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ padding:14px; }

    .topbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      background:var(--card); border:1px solid var(--border);
      padding:10px; border-radius:10px;
    }
    button{
      border:1px solid var(--border); background:#fff; padding:7px 12px; border-radius:8px;
      cursor:pointer; font-weight:600;
    }
    button.primary{ background:var(--blue); color:#fff; border-color:var(--blue); }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .status{ margin-left:6px; color:var(--muted); font-size:13px; }
    .err{ margin-top:10px; color:#b00; white-space:pre-wrap; font-size:13px; }

    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:12px;
      align-items:start;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
    }
    #calendar{ min-height: 520px; }

    .anaTitle{ font-weight:800; margin-bottom:10px; }
    .anaBox{ border:1px solid var(--border); border-radius:10px; padding:10px; margin-bottom:10px; }
    .anaRow{ display:flex; justify-content:space-between; align-items:baseline; gap:10px; }
    .anaLabel{ color:var(--muted); font-size:13px; }
    .anaVal{ font-weight:800; }
    .bar{ height:8px; border-radius:999px; background:#eef2ff; overflow:hidden; margin-top:8px; }
    .bar > div{ height:8px; width:0%; background:var(--blue); }

    /* Modal */
    .modalMask{
      position:fixed; inset:0; background:rgba(17,24,39,.55);
      display:none; align-items:center; justify-content:center;
      padding:16px; z-index:9999;
    }
    .modal{
      width:min(900px, 96vw);
      background:#fff; border-radius:14px; overflow:hidden;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px; border-bottom:1px solid var(--border);
      font-weight:800;
    }
    .modalBody{ padding:16px; }
    .modalFoot{
      display:flex; justify-content:flex-end; gap:10px;
      padding:14px 16px; border-top:1px solid var(--border);
    }
    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .field label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }
    .field input{
      width:100%; box-sizing:border-box;
      padding:10px 12px; border:1px solid var(--border); border-radius:10px;
      outline:none;
    }
    .hint{ color:var(--muted); font-size:12px; margin-top:8px; }
    .smallNote{ color:var(--muted); font-size:12px; margin-top:6px; }

    /* FullCalendar event styles */
    .fc .fc-toolbar-title{ font-size:18px; font-weight:900; }
    .evt{
      padding:2px 6px; border-radius:6px; color:#fff; font-size:12px; font-weight:800;
      display:flex; justify-content:space-between; gap:6px;
    }
    .evt .amt{ font-weight:900; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <button id="btnRefresh">Refresh</button>
    <button id="btnGenerate" class="primary">Generate schedule</button>
    <button id="btnSettings">Settings</button>
    <span id="status" class="status"></span>
  </div>

  <div id="err" class="err"></div>

  <div class="grid">
    <div class="card">
      <div id="calendar"></div>
    </div>

    <div class="card">
      <div class="anaTitle">Analitika</div>

      <div class="anaBox">
        <div class="anaRow">
          <div class="anaLabel">Paid</div>
          <div class="anaVal" id="anaPaid">0 so'm</div>
        </div>
        <div class="bar"><div id="barPaid"></div></div>
      </div>

      <div class="anaBox">
        <div class="anaRow">
          <div class="anaLabel">Expected</div>
          <div class="anaVal" id="anaExpected">0 so'm</div>
        </div>
        <div class="bar"><div id="barExpected"></div></div>
      </div>

      <div class="anaBox">
        <div class="anaRow">
          <div class="anaLabel">Overdue</div>
          <div class="anaVal" id="anaOverdue">0 so'm</div>
        </div>
        <div class="bar"><div id="barOverdue"></div></div>
      </div>

      <div class="anaBox">
        <div class="anaRow">
          <div class="anaLabel">Jami</div>
          <div class="anaVal" id="anaTotal">0 so'm</div>
        </div>
        <div class="smallNote" id="anaCount">0 ta</div>
      </div>

      <div class="hint">
        Ranglar: Yashil – paid, Sariq – muddat yaqin, Qizil – prosrochka.
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modalMask" id="mSettings">
  <div class="modal">
    <div class="modalHead">
      <div>Settings</div>
      <button id="btnCloseSettings">Close</button>
    </div>
    <div class="modalBody">
      <div class="formGrid">
        <div class="field">
          <label>SPA nomi (Title)</label>
          <input id="cfgSpaTitle" />
        </div>

        <div class="field">
          <label>Deal parent field</label>
          <input id="cfgParentField" />
        </div>

        <div class="field">
          <label>Due date field code (Date)</label>
          <input id="cfgDueField" />
        </div>

        <div class="field">
          <label>Amount field code (Number)</label>
          <input id="cfgAmountField" />
        </div>

        <div class="field">
          <label>Installment field code (String)</label>
          <input id="cfgInstField" />
        </div>

        <div class="field">
          <label>Sariq (muddat yaqin) – kun</label>
          <input id="cfgYellowDays" type="number" min="0" />
        </div>

        <div class="field">
          <label>StageId: PENDING</label>
          <input id="cfgStagePending" />
        </div>

        <div class="field">
          <label>StageId: PAID</label>
          <input id="cfgStagePaid" />
        </div>
      </div>

      <div class="hint">
        Field/stage kodlar — SPA sozlamalaridan olinadi. Save bosilganda widget shu qiymatlar bilan ishlaydi.
      </div>
    </div>
    <div class="modalFoot">
      <button id="btnCancelSettings">Cancel</button>
      <button id="btnSaveSettings" class="primary">Save</button>
    </div>
  </div>
</div>

<!-- GENERATE MODAL -->
<div class="modalMask" id="mGenerate">
  <div class="modal">
    <div class="modalHead">
      <div>Generate schedule</div>
      <button id="btnCloseGenerate">Close</button>
    </div>
    <div class="modalBody">
      <div class="formGrid">
        <div class="field">
          <label>Months</label>
          <input id="genMonths" type="number" min="1" value="12" />
        </div>

        <div class="field">
          <label>Start date</label>
          <input id="genStart" type="date" />
        </div>

        <div class="field">
          <label>Total amount (so'm)</label>
          <input id="genTotal" inputmode="numeric" placeholder="10 000 000" />
        </div>

        <div class="field">
          <label>Har oy (auto)</label>
          <input id="genPerMonth" disabled />
        </div>
      </div>

      <div class="smallNote" id="genRemainderNote"></div>
      <div class="err" id="genErr"></div>

      <div class="hint">
        Create bosilganda har oy uchun SPA item yaratiladi va Deal ID ga bog‘lanadi.
      </div>
    </div>
    <div class="modalFoot">
      <button id="btnCancelGenerate">Cancel</button>
      <button id="btnDoGenerate" class="primary">Create</button>
    </div>
  </div>
</div>

<script>
(function () {
  // =========================
  // Helpers
  // =========================
  const LS_KEY = "muddatli_tolov_cfg_v3";

  function $(id){ return document.getElementById(id); }

  function setText(id, value){
    const el = $(id);
    if (!el) return;
    el.textContent = value ?? "";
  }

  function setError(msg){ setText("err", msg ? String(msg) : ""); }
  function setStatus(msg){ setText("status", msg ? String(msg) : ""); }

  function openModal(id){ const m = $(id); if (m) m.style.display = "flex"; }
  function closeModal(id){ const m = $(id); if (m) m.style.display = "none"; }

  function formatSom(n){
    const x = Number(n || 0);
    if (!isFinite(x)) return "0 so'm";
    return x.toLocaleString("ru-RU") + " so'm";
  }

  function parseMoney(str){
    if (str == null) return 0;
    const s = String(str).replace(/[^\d]/g, "");
    return s ? Number(s) : 0;
  }

  function isoDate(d){
    const yy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yy}-${mm}-${dd}`;
  }

  function todayISO(){ return isoDate(new Date()); }

  function addMonths(yyyyMmDd, add){
    const [y,m,d] = yyyyMmDd.split("-").map(x=>parseInt(x,10));
    const dt = new Date(Date.UTC(y, m-1, d));
    dt.setUTCMonth(dt.getUTCMonth() + add);
    return `${dt.getUTCFullYear()}-${String(dt.getUTCMonth()+1).padStart(2,"0")}-${String(dt.getUTCDate()).padStart(2,"0")}`;
  }

  function dateToNum(yyyyMmDd){ return Number(String(yyyyMmDd || "").replaceAll("-","")); }

  // =========================
  // DEFAULT CONFIG (SIZ BERGAN QIYMATLAR)
  // MUHIM: kalitlar spaTitle/parentField/... bo'lishi shart
  // =========================
  const DEFAULTS = {
    spaTitle: "MUDDATLI TO'LOV",
    parentField: "parentId2",
    dueField: "UF_CRM_15_1768516812",
    amountField: "UF_CRM_15_1768516945",
    instField: "UF_CRM_15_1768516987",
    stagePending: "DT1058_19:UC_9HOY6X",
    stagePaid: "DT1058_19:SUCCESS",
    yellowDays: 3
  };

  function loadCfg(){
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return { ...DEFAULTS };
    try{
      const obj = JSON.parse(raw) || {};
      return { ...DEFAULTS, ...obj }; // DEFAULT + user
    } catch {
      return { ...DEFAULTS };
    }
  }

  function saveCfg(cfg){
    localStorage.setItem(LS_KEY, JSON.stringify(cfg));
  }

  function cfgToUI(cfg){
    $("cfgSpaTitle").value = cfg.spaTitle || "";
    $("cfgParentField").value = cfg.parentField || "";
    $("cfgDueField").value = cfg.dueField || "";
    $("cfgAmountField").value = cfg.amountField || "";
    $("cfgInstField").value = cfg.instField || "";
    $("cfgStagePending").value = cfg.stagePending || "";
    $("cfgStagePaid").value = cfg.stagePaid || "";
    $("cfgYellowDays").value = String(cfg.yellowDays ?? 3);
  }

  function uiToCfg(){
    return {
      spaTitle: $("cfgSpaTitle").value.trim(),
      parentField: $("cfgParentField").value.trim(),
      dueField: $("cfgDueField").value.trim(),
      amountField: $("cfgAmountField").value.trim(),
      instField: $("cfgInstField").value.trim(),
      stagePending: $("cfgStagePending").value.trim(),
      stagePaid: $("cfgStagePaid").value.trim(),
      yellowDays: Number($("cfgYellowDays").value || 0)
    };
  }

  function validateCfg(cfg){
    const required = ["spaTitle","parentField","dueField","amountField","instField","stagePending","stagePaid"];
    for (const k of required){
      if (!cfg[k]) throw new Error("Settings to‘liq emas: " + k + " bo‘sh.");
    }
  }

  // =========================
  // Bitrix REST helpers
  // =========================
  function bxCall(method, params){
    return new Promise((resolve, reject)=>{
      BX24.callMethod(method, params, function(res){
        if (res.error()){
          reject(new Error(method + ": " + res.error() + " " + (res.error_description() || "")));
          return;
        }
        resolve(res.data());
      });
    });
  }

  function bxCallAll(method, params){
    return new Promise((resolve, reject)=>{
      const all = [];
      BX24.callMethod(method, params, function(res){
        if (res.error()){
          reject(new Error(method + ": " + res.error() + " " + (res.error_description() || "")));
          return;
        }
        const data = res.data();
        if (Array.isArray(data)) all.push(...data);
        if (res.more()) res.next();
        else resolve(all);
      });
    });
  }

  async function getDealIdFromPlacement(){
    const info = await new Promise((resolve)=>BX24.placement.info(resolve));
    const opts = info && info.options ? info.options : {};
    const id =
      opts.ID || opts.id || opts.ENTITY_ID || opts.entityId ||
      (opts.ENTITY && (opts.ENTITY.ID || opts.ENTITY.id)) ||
      opts.DEAL_ID || null;
    return id ? Number(id) : null;
  }

  async function resolveEntityTypeIdByTitle(title){
    const list = await bxCallAll("crm.type.list", { order: { id: "ASC" } });
    const t = String(title || "").trim().toLowerCase();
    const found = list.find(x => String(x.title || "").trim().toLowerCase() === t);
    if (!found){
      throw new Error("SPA topilmadi: crm.type.list ichida '" + title + "' yo‘q. SPA nomini tekshiring.");
    }
    return found.entityTypeId || found.id;
  }

  // =========================
  // State
  // =========================
  let calendar = null;
  let dealId = null;
  let entityTypeId = null;
  let currentEvents = [];

  function computeStatus(cfg, item){
    const due = String(item[cfg.dueField] || "").substring(0,10);
    const paid = item.stageId === cfg.stagePaid;
    const today = dateToNum(todayISO());
    const dueN = due ? dateToNum(due) : 0;

    if (paid) return "paid";
    if (!due) return "expected";
    if (dueN < today) return "overdue";

    const yellowDays = Number(cfg.yellowDays || 0);
    if (yellowDays > 0){
      const dtToday = new Date(todayISO() + "T00:00:00");
      const dtDue = new Date(due + "T00:00:00");
      const diffDays = Math.floor((dtDue - dtToday) / (1000*60*60*24));
      if (diffDays <= yellowDays) return "near";
    }
    return "expected";
  }

  function statusColor(st){
    if (st === "paid") return "var(--green)";
    if (st === "near") return "var(--yellow)";
    if (st === "overdue") return "var(--red)";
    return "var(--blue)";
  }

  function updateAnalytics(){
    let paidSum = 0, expSum = 0, overSum = 0, count = 0;

    for (const e of currentEvents){
      count++;
      const amt = Number(e.extendedProps.amount || 0);
      const st = e.extendedProps.status;
      if (st === "paid") paidSum += amt;
      else if (st === "overdue") overSum += amt;
      else expSum += amt;
    }
    const total = paidSum + expSum + overSum;

    setText("anaPaid", formatSom(paidSum));
    setText("anaExpected", formatSom(expSum));
    setText("anaOverdue", formatSom(overSum));
    setText("anaTotal", formatSom(total));
    setText("anaCount", count + " ta");

    const pct = (v)=> total>0 ? Math.round((v/total)*100) : 0;
    $("barPaid").style.width = pct(paidSum) + "%";
    $("barExpected").style.width = pct(expSum) + "%";
    $("barOverdue").style.width = pct(overSum) + "%";
  }

  async function loadToCalendar(){
    const cfg = loadCfg();
    validateCfg(cfg);

    setError("");
    setStatus("Loading…");

    if (!dealId) throw new Error("Deal ID olinmadi. Widget faqat Deal ichida ishlaydi.");
    if (!entityTypeId) entityTypeId = await resolveEntityTypeIdByTitle(cfg.spaTitle);

    const filter = {};
    filter[cfg.parentField] = dealId;

    const items = await bxCallAll("crm.item.list", {
      entityTypeId,
      filter,
      select: ["id","title","stageId", cfg.dueField, cfg.amountField, cfg.instField]
    });

    const events = [];
    for (const it of items){
      const due = String(it[cfg.dueField] || "").substring(0,10);
      if (!due) continue;

      const amt = Number(it[cfg.amountField] || 0);
      const inst = String(it[cfg.instField] || "");
      const st = computeStatus(cfg, it);

      events.push({
        id: String(it.id),
        title: inst,
        start: due,
        allDay: true,
        extendedProps: {
          amount: amt,
          installment: inst,
          status: st,
          stageId: it.stageId
        }
      });
    }

    currentEvents = events;

    calendar.removeAllEvents();
    calendar.addEventSource(events);

    updateAnalytics();
    setStatus("Loaded: " + events.length);
  }

  async function markPaid(itemId){
    const cfg = loadCfg();
    validateCfg(cfg);
    if (!entityTypeId) entityTypeId = await resolveEntityTypeIdByTitle(cfg.spaTitle);

    await bxCall("crm.item.update", {
      entityTypeId,
      id: Number(itemId),
      fields: { stageId: cfg.stagePaid }
    });
  }

  async function generateSchedule(){
    const cfg = loadCfg();
    validateCfg(cfg);

    const months = Number($("genMonths").value || 0);
    const start = $("genStart").value; // YYYY-MM-DD
    const total = parseMoney($("genTotal").value);

    if (!months || months < 1) throw new Error("Months noto‘g‘ri.");
    if (!/^\d{4}-\d{2}-\d{2}$/.test(start)) throw new Error("Start date noto‘g‘ri.");
    if (!total || total <= 0) throw new Error("Total amount noto‘g‘ri.");
    if (!dealId) throw new Error("Deal ID yo‘q.");

    if (!entityTypeId) entityTypeId = await resolveEntityTypeIdByTitle(cfg.spaTitle);

    setStatus("Creating items…");

    const per = Math.floor(total / months);
    const rem = total - per * months;

    for (let i=1; i<=months; i++){
      const due = addMonths(start, i-1);
      const amt = per + (i === months ? rem : 0);
      const inst = `${i}/${months}`;

      const fields = {};
      fields[cfg.dueField] = due;
      fields[cfg.amountField] = amt;
      fields[cfg.instField] = inst;
      fields.stageId = cfg.stagePending;
      fields[cfg.parentField] = dealId;

      await bxCall("crm.item.add", { entityTypeId, fields });
    }

    setStatus("Created: " + months);
  }

  function initCalendar(){
    calendar = new FullCalendar.Calendar($("calendar"), {
      initialView: "dayGridMonth",
      height: "auto",
      headerToolbar: { left: "prev,next today", center: "title", right: "" },

      eventContent: function(arg){
        const st = arg.event.extendedProps.status;
        const amt = arg.event.extendedProps.amount;
        const inst = arg.event.extendedProps.installment || arg.event.title;

        const wrap = document.createElement("div");
        wrap.className = "evt";
        wrap.style.background = statusColor(st);

        const left = document.createElement("span");
        left.textContent = inst;

        const right = document.createElement("span");
        right.className = "amt";
        right.textContent = Number(amt||0).toLocaleString("ru-RU"); // so'm format (raqam)

        wrap.appendChild(left);
        wrap.appendChild(right);

        return { domNodes: [wrap] };
      },

      eventClick: async function(info){
        try{
          setError("");
          const st = info.event.extendedProps.status;
          if (st === "paid") return;

          const ok = confirm("Bu to‘lovni PAID qilishni xohlaysizmi?");
          if (!ok) return;

          setStatus("Updating…");
          await markPaid(info.event.id);
          await loadToCalendar();
          setStatus("Updated");
        } catch(e){
          setStatus("");
          setError(e?.message || String(e));
        }
      }
    });

    calendar.render();
  }

  // =========================
  // UI wiring
  // =========================
  function recalcGeneratePreview(){
    const months = Number($("genMonths").value || 0);
    const total = parseMoney($("genTotal").value);
    if (!months || months < 1 || !total){
      $("genPerMonth").value = "";
      setText("genRemainderNote", "");
      return;
    }
    const per = Math.floor(total / months);
    const rem = total - per * months;
    $("genPerMonth").value = formatSom(per);
    setText("genRemainderNote", rem ? ("Oxirgi oyga qo‘shimcha: " + formatSom(rem)) : "");
  }

  function moneyMaskInput(el){
    el.addEventListener("input", ()=>{
      const n = parseMoney(el.value);
      el.value = n ? n.toLocaleString("ru-RU") : "";
      recalcGeneratePreview();
    });
  }

  function bindButtons(){
    $("btnRefresh").onclick = async ()=>{
      try{ setError(""); await loadToCalendar(); }
      catch(e){ setError(e?.message || String(e)); }
    };

    $("btnSettings").onclick = ()=>{
      const cfg = loadCfg();
      cfgToUI(cfg);
      openModal("mSettings");
    };

    $("btnCloseSettings").onclick = ()=>closeModal("mSettings");
    $("btnCancelSettings").onclick = ()=>closeModal("mSettings");

    $("btnSaveSettings").onclick = async ()=>{
      try{
        const cfg = uiToCfg();
        validateCfg(cfg);
        saveCfg(cfg);
        entityTypeId = null;
        closeModal("mSettings");
        await loadToCalendar();
      } catch(e){
        setError(e?.message || String(e));
      }
    };

    $("btnGenerate").onclick = ()=>{
      $("genStart").value = todayISO();
      $("genMonths").value = "12";
      $("genTotal").value = "";
      $("genPerMonth").value = "";
      setText("genRemainderNote", "");
      setText("genErr", "");
      openModal("mGenerate");
    };

    $("btnCloseGenerate").onclick = ()=>closeModal("mGenerate");
    $("btnCancelGenerate").onclick = ()=>closeModal("mGenerate");

    $("btnDoGenerate").onclick = async ()=>{
      try{
        setText("genErr", "");
        $("btnDoGenerate").disabled = true;
        await generateSchedule();
        closeModal("mGenerate");
        await loadToCalendar();
      } catch(e){
        setText("genErr", e?.message || String(e));
      } finally {
        $("btnDoGenerate").disabled = false;
      }
    };

    $("genMonths").addEventListener("input", recalcGeneratePreview);
    moneyMaskInput($("genTotal"));
  }

  // =========================
  // Boot
  // =========================
  BX24.init(async function(){
    try{
      setError("");
      setStatus("Init…");

      initCalendar();
      bindButtons();

      // Settings default to'ldirish (siz bergan qiymatlar bilan)
      const cfg = loadCfg();
      cfgToUI(cfg);

      dealId = await getDealIdFromPlacement();
      if (!dealId) throw new Error("Deal ID olinmadi. Widget faqat Deal ichida (CRM Deal) ishlaydi.");

      await loadToCalendar();
      setStatus("Ready");
    } catch(e){
      setStatus("");
      setError(e?.message || String(e));
    }
  });

})();
</script>

</body>
</html>
