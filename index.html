<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MUDDATLI TO'LOV</title>

  <!-- Bitrix -->
  <script src="https://api.bitrix24.com/api/v1/"></script>

  <!-- FullCalendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#fff; }
    .bar { display:flex; gap:8px; align-items:center; padding:10px; border-bottom:1px solid #eee; position:sticky; top:0; background:#fff; z-index:10; }
    button { padding:7px 12px; cursor:pointer; }
    #status { font-size:12px; color:#666; }
    #err { padding:10px; color:#b00; white-space:pre-wrap; }
    #calendar { padding:10px; }
    .panel { display:none; padding:10px; border-top:1px solid #eee; }
  </style>
</head>
<body>

  <div class="bar">
    <button id="btnRefresh" type="button">Refresh</button>
    <button id="btnGenerate" type="button">Generate schedule</button>
    <button id="btnSettings" type="button">Settings</button>
    <div id="status"></div>
  </div>

  <div id="err"></div>
  <div id="calendar"></div>

  <div id="settingsPanel" class="panel">
    <b>Settings panel opened</b>
    <div style="margin-top:8px; font-size:12px; color:#666;">
      (Keyin bu yerga SPA field kodlari va stageId larni qo‘shamiz)
    </div>
  </div>

  <div id="genPanel" class="panel">
    <b>Generate panel opened</b>
    <div style="margin-top:8px; font-size:12px; color:#666;">
      (Keyin bu yerga oylar/amount/start date form qo‘shamiz)
    </div>
  </div>

<script>
(function(){
  const $ = (id) => document.getElementById(id);

  function setStatus(t){ $("status").textContent = t || ""; }
  function setErr(t){ $("err").textContent = t || ""; }
  function show(panelId){
    ["settingsPanel","genPanel"].forEach(id => $(id).style.display = (id===panelId ? "block" : "none"));
  }

  function mustBX24(){
    if (typeof BX24 === "undefined") throw new Error("BX24 not defined. (iframe ichida Bitrix script yuklanmadi)");
  }

  async function getDealIdFromPlacement(){
    mustBX24();
    const info = await new Promise((resolve) => BX24.placement.info(resolve));
    const opts = (info && info.options) ? info.options : {};
    // Deal placement'da odatda ID bo'ladi
    const id = opts.ID || opts.id || opts.ENTITY_ID || opts.entityId || opts.DEAL_ID || null;
    return id ? Number(id) : null;
  }

  // Calendar init (minimal)
  let calendar;
  function initCalendar(){
    calendar = new FullCalendar.Calendar($("calendar"), {
      initialView: "dayGridMonth",
      height: "auto",
      events: []
    });
    calendar.render();
  }

  // Buttons wiring
  function wireButtons(){
    $("btnRefresh").addEventListener("click", async () => {
      try {
        setErr("");
        setStatus("Refresh clicked...");
        const dealId = await getDealIdFromPlacement();
        setStatus("Deal ID = " + dealId);
        // Hozircha demo event qo‘shamiz:
        calendar.removeAllEvents();
        if (dealId) {
          calendar.addEvent({ title: "Deal #" + dealId, start: new Date().toISOString().slice(0,10), allDay:true });
        }
      } catch(e){ setErr(String(e.message || e)); setStatus(""); }
    });

    $("btnSettings").addEventListener("click", () => {
      setErr("");
      show("settingsPanel");
      setStatus("Settings opened");
    });

    $("btnGenerate").addEventListener("click", () => {
      setErr("");
      show("genPanel");
      setStatus("Generate opened");
    });
  }

  // Boot
  BX24.init(async function(){
    try{
      setErr("");
      setStatus("BX24.init OK");
      initCalendar();
      wireButtons();

      const dealId = await getDealIdFromPlacement();
      if (!dealId) {
        setStatus("Opened outside deal card (Deal ID not found)");
      } else {
        setStatus("Ready. Deal ID = " + dealId);
      }
    } catch(e){
      setErr(String(e.message || e));
      setStatus("");
    }
  });
})();
</script>

</body>
</html>
