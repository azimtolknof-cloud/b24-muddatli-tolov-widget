<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Muddatli To'lov</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- BX24 loader (fallback bilan) -->
  <script>
    (function(){
      function load(src){
        return new Promise((resolve,reject)=>{
          var s=document.createElement('script');
          s.src=src;
          s.onload=resolve;
          s.onerror=reject;
          document.head.appendChild(s);
        });
      }
      window.__bxReady = (async ()=>{
        if (window.BX24) return true;
        try{ await load("https://api.bitrix24.com/api/v1/"); }catch(e){}
        if (window.BX24) return true;
        // Fallback (ba'zi holatlarda shu yordam beradi)
        try{ await load("//api.bitrix24.com/api/v1/"); }catch(e){}
        return !!window.BX24;
      })();
    })();
  </script>

  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --border:#e6e8ee; --text:#111827; --muted:#6b7280;
      --blue:#2563eb; --green:#16a34a; --red:#ef4444; --yellow:#f59e0b;
    }
    body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{padding:14px}
    .topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;background:var(--card);border:1px solid var(--border);padding:10px;border-radius:10px}
    .btn{border:1px solid var(--border);background:#fff;padding:7px 12px;border-radius:8px;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--blue);border-color:var(--blue);color:#fff}
    .btn.icon{width:38px;height:34px;display:flex;align-items:center;justify-content:center}
    .status{color:var(--muted);font-size:13px;margin-left:6px}
    .err{margin-top:10px;color:#b00;white-space:pre-wrap;font-size:13px}

    .grid{margin-top:12px;display:grid;grid-template-columns: 420px 1fr;gap:12px;align-items:start}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .h{font-weight:900;font-size:16px;margin:0 0 10px}
    .kv{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
    .k{border:1px solid var(--border);border-radius:10px;padding:10px}
    .k .l{color:var(--muted);font-size:12px}
    .k .v{font-weight:900;font-size:18px;margin-top:6px}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;font-size:14px}
    .table th{color:var(--muted);font-size:12px}
    .act{display:flex;gap:8px}
    .mini{font-size:12px;color:var(--muted)}
    .danger{color:var(--red)}
    .linkbtn{background:transparent;border:none;color:var(--blue);cursor:pointer;font-weight:800;padding:0}
    .mutebtn{background:transparent;border:none;color:var(--muted);cursor:pointer;font-weight:800;padding:0}

    /* Modal */
    .mask{position:fixed;inset:0;background:rgba(17,24,39,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .modal{width:min(860px,96vw);background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.25)}
    .mhead{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);font-weight:900}
    .mbody{padding:16px}
    .mfoot{display:flex;justify-content:flex-end;gap:10px;padding:14px 16px;border-top:1px solid var(--border)}
    .fg{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .f label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
    .f input,.f select{width:100%;box-sizing:border-box;padding:10px 12px;border:1px solid var(--border);border-radius:10px;outline:none}
    .note{color:var(--muted);font-size:12px;margin-top:8px}
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <button class="btn" id="btnRefresh">Refresh</button>

    <!-- + : Payment accept -->
    <button class="btn icon primary" id="btnPay" title="To'lov qabul qilish">+</button>

    <!-- Calculator : New plan -->
    <button class="btn icon" id="btnPlan" title="Yangi muddatli to'lov rejasi (kalkulyator)">üßÆ</button>

    <!-- Settings -->
    <button class="btn" id="btnSettings">Settings</button>

    <span class="status" id="status"></span>
  </div>

  <div id="err" class="err"></div>

  <div class="grid">
    <!-- LEFT: stats -->
    <div class="card">
      <h3 class="h">Umumiy statistika</h3>

      <div class="row" style="margin-bottom:10px">
        <span class="pill" id="pillDeal">Deal: ‚Äî</span>
        <span class="pill" id="pillPlan">Plan: ‚Äî</span>
      </div>

      <div class="kv">
        <div class="k">
          <div class="l">Kurs</div>
          <div class="v" id="stCourse">‚Äî</div>
        </div>
        <div class="k">
          <div class="l">Kurs bo‚Äòyicha tushishi kerak (jami)</div>
          <div class="v" id="stTotal">0 so‚Äòm</div>
        </div>
        <div class="k">
          <div class="l">To‚Äòlangan summa</div>
          <div class="v" id="stPaid">0 so‚Äòm</div>
        </div>
        <div class="k">
          <div class="l">Qolgan summa</div>
          <div class="v" id="stRemain">0 so‚Äòm</div>
        </div>
      </div>

      <div style="margin-top:12px" class="row">
        <button class="btn danger" id="btnDeletePlan" title="Umumiy kurs to‚Äòlov rejasini o‚Äòchirish">Plan‚Äôni o‚Äòchirish</button>
        <span class="mini" id="planHint"></span>
      </div>
    </div>

    <!-- RIGHT: payments list -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h3 class="h" style="margin:0">To‚Äòlovlar ro‚Äòyxati</h3>
        <span class="mini" id="payCount">0 ta</span>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th>Sana</th>
            <th>Summa</th>
            <th>Izoh</th>
            <th style="width:120px">Amallar</th>
          </tr>
        </thead>
        <tbody id="payBody">
          <tr><td colspan="4" class="mini">Loading‚Ä¶</td></tr>
        </tbody>
      </table>

      <div class="note">
        Eslatma: ‚Äúqisman to‚Äòlov‚Äù kiritilsa, tizim qolgan summani qayta hisoblaydi (Remaining = Total - Paid).
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL (entityTypeId lar + fieldlar + stages) -->
<div class="mask" id="mSettings">
  <div class="modal">
    <div class="mhead">
      <div>Settings</div>
      <button class="btn" id="btnCloseSettings">Close</button>
    </div>
    <div class="mbody">
      <div class="fg">
        <div class="f">
          <label>Plan SPA Title (aniq nomi)</label>
          <input id="cfgPlanTitle" placeholder="MUDDATLI TO'LOV" />
        </div>
        <div class="f">
          <label>Payments SPA Title (aniq nomi)</label>
          <input id="cfgPayTitle" placeholder="TO'LOVLAR" />
        </div>

        <div class="f">
          <label>Deal parent field (Plan/Payment‚Äôda)</label>
          <input id="cfgParentField" />
        </div>

        <div class="f">
          <label>Plan: Total amount field code</label>
          <input id="cfgPlanTotalField" placeholder="UF_CRM_xxx" />
        </div>

        <div class="f">
          <label>Plan: Course field code</label>
          <input id="cfgPlanCourseField" placeholder="UF_CRM_xxx" />
        </div>

        <div class="f">
          <label>Payment: Amount field code</label>
          <input id="cfgPayAmountField" placeholder="UF_CRM_xxx" />
        </div>

        <div class="f">
          <label>Payment: Date field code</label>
          <input id="cfgPayDateField" placeholder="UF_CRM_xxx" />
        </div>

        <div class="f">
          <label>Payment: Comment field code</label>
          <input id="cfgPayCommentField" placeholder="UF_CRM_xxx" />
        </div>
      </div>

      <div class="note">
        Bu ‚ÄúSettings‚Äù portal bo‚Äòyicha BX24.appOption orqali saqlanadi. Hamma operatorlarda bir xil bo‚Äòladi.
      </div>
      <div class="err" id="cfgErr"></div>
    </div>
    <div class="mfoot">
      <button class="btn" id="btnCancelSettings">Cancel</button>
      <button class="btn primary" id="btnSaveSettings">Save</button>
    </div>
  </div>
</div>

<!-- PAYMENT MODAL (+) -->
<div class="mask" id="mPay">
  <div class="modal">
    <div class="mhead">
      <div>To‚Äòlov qabul qilish</div>
      <button class="btn" id="btnClosePay">Close</button>
    </div>
    <div class="mbody">
      <div class="fg">
        <div class="f">
          <label>Sana</label>
          <input id="payDate" type="date" />
        </div>
        <div class="f">
          <label>Summa (so‚Äòm)</label>
          <input id="payAmount" inputmode="numeric" placeholder="500 000" />
        </div>
        <div class="f" style="grid-column:1 / -1">
          <label>Izoh</label>
          <input id="payComment" placeholder="Misol: Naqd / Click / oldindan qisman" />
        </div>
      </div>
      <div class="err" id="payErr"></div>
    </div>
    <div class="mfoot">
      <button class="btn" id="btnCancelPay">Cancel</button>
      <button class="btn primary" id="btnDoPay">Saqlash</button>
    </div>
  </div>
</div>

<!-- PLAN MODAL (Calculator) -->
<div class="mask" id="mPlan">
  <div class="modal">
    <div class="mhead">
      <div>Yangi muddatli to‚Äòlov rejasi</div>
      <button class="btn" id="btnClosePlan">Close</button>
    </div>
    <div class="mbody">
      <div class="fg">
        <div class="f">
          <label>Kurs</label>
          <select id="plCourse"></select>
        </div>
        <div class="f">
          <label>Kurs narxi (auto)</label>
          <input id="plCoursePrice" disabled />
        </div>

        <div class="f">
          <label>Oldindan to‚Äòlov</label>
          <input id="plPrepay" inputmode="numeric" placeholder="0" />
        </div>
        <div class="f">
          <label>Muddat (oy)</label>
          <input id="plMonths" placeholder="3 / 6 / 12 yoki qo‚Äòlda" inputmode="numeric" />
        </div>

        <div class="f">
          <label>Birinchi to‚Äòlov sanasi</label>
          <input id="plFirstDate" type="date" />
        </div>
        <div class="f">
          <label>Hisoblangan: Qolgan summa</label>
          <input id="plRemainPreview" disabled />
        </div>
      </div>

      <div class="note">
        Plan saqlangach, operator ‚Äú+‚Äù orqali istalgan sanada istalgan summani kiritadi. Remaining avtomatik = Total - Paid.
      </div>
      <div class="err" id="plErr"></div>
    </div>
    <div class="mfoot">
      <button class="btn" id="btnCancelPlan">Cancel</button>
      <button class="btn primary" id="btnDoPlan">Create plan</button>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  const APP_KEYS = {
    SETTINGS: "mt_settings_v1",
    COURSES: "mt_courses_v1",
  };

  // DEFAULT: kurslar (admin‚Äôda keyin o‚Äòzgartirasiz)
  const DEFAULT_COURSES = [
    { id:"course1", name:"Kurs 1", price:1000000, terms:[3,6,12] },
    { id:"course2", name:"Kurs 2", price:2000000, terms:[3,6] }
  ];

  // DEFAULT SETTINGS (sizning portalga moslab keyin admin‚Äôda to‚Äòldirasiz)
  const DEFAULT_SETTINGS = {
    planSpaTitle: "MUDDATLI TO'LOV",
    paySpaTitle: "TO'LOVLAR",
    parentField: "parentId2",
    // plan fields (bularni admin‚Äôda real field code bilan to‚Äòldirasiz)
    planTotalField: "UF_CRM_15_1768516945", // vaqtincha amount fieldingizdan foydalandik
    planCourseField: "UF_CRM_15_1768516987", // vaqtincha installment fieldingizdan foydalandik
    // payment fields (create qilgan Payment SPA field codes)
    payAmountField: "",
    payDateField: "",
    payCommentField: ""
  };

  function showErr(msg){ $("err").textContent = msg ? String(msg) : ""; }
  function status(msg){ $("status").textContent = msg ? String(msg) : ""; }

  function openMask(id){ $(id).style.display="flex"; }
  function closeMask(id){ $(id).style.display="none"; }

  function money(n){
    const x=Number(n||0);
    return (isFinite(x)? x.toLocaleString("ru-RU"): "0") + " so‚Äòm";
  }
  function parseMoney(v){
    const s=String(v||"").replace(/[^\d]/g,"");
    return s? Number(s): 0;
  }
  function todayISO(){
    const d=new Date();
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const dd=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }

  // --- BX24 wrappers
  function bxCall(method, params){
    return new Promise((resolve,reject)=>{
      BX24.callMethod(method, params, function(res){
        if(res.error()){
          reject(new Error(method + ": " + res.error() + " " + (res.error_description()||"")));
          return;
        }
        resolve(res.data());
      });
    });
  }

  function bxCallAll(method, params){
    return new Promise((resolve,reject)=>{
      const all=[];
      BX24.callMethod(method, params, function(res){
        if(res.error()){
          reject(new Error(method + ": " + res.error() + " " + (res.error_description()||"")));
          return;
        }
        const d=res.data();
        if(Array.isArray(d)) all.push(...d);
        if(res.more()) res.next();
        else resolve(all);
      });
    });
  }

  function appOptionGet(key, fallback){
    return new Promise((resolve)=>{
      BX24.appOption.get(key, function(value){
        if(value == null || value === ""){
          resolve(fallback);
          return;
        }
        try{ resolve(JSON.parse(value)); }catch(e){ resolve(fallback); }
      });
    });
  }
  function appOptionSet(key, obj){
    return new Promise((resolve,reject)=>{
      BX24.appOption.set(key, JSON.stringify(obj), function(res){
        if(res && res.error && res.error()){
          reject(new Error("appOption.set: " + res.error()));
          return;
        }
        resolve(true);
      });
    });
  }

  // Deal ID robust
  async function getDealId(){
    const info = await new Promise((resolve)=>BX24.placement.info(resolve));
    const opts = (info && info.options) ? info.options : {};
    const candidates = [
      opts.ID, opts.id,
      opts.ENTITY_ID, opts.entityId,
      opts.ENTITY_VALUE_ID, opts.entityValueId,
      opts.DEAL_ID, opts.dealId,
      opts.OWNER_ID, opts.ownerId
    ].filter(Boolean);

    if(candidates.length) return Number(candidates[0]);

    // ba'zi joylarda opts.ENTITY ichida bo‚Äòladi
    if(opts.ENTITY && (opts.ENTITY.ID || opts.ENTITY.id)) return Number(opts.ENTITY.ID || opts.ENTITY.id);

    return null;
  }

  async function resolveEntityTypeIdByTitle(title){
    const list = await bxCallAll("crm.type.list", { order:{ id:"ASC" }});
    const t=String(title||"").trim().toLowerCase();
    const f=list.find(x=>String(x.title||"").trim().toLowerCase()===t);
    if(!f) throw new Error("SPA topilmadi: '" + title + "'. CRM ‚Üí Smart Process sozlamasidan aniq nomini tekshiring.");
    return f.entityTypeId || f.id;
  }

  // Data loaders
  let dealId=null;
  let cfg=null;
  let courses=null;

  let planEntityTypeId=null;
  let payEntityTypeId=null;

  async function ensureConfig(){
    cfg = await appOptionGet(APP_KEYS.SETTINGS, DEFAULT_SETTINGS);
    // UI fill
    $("cfgPlanTitle").value = cfg.planSpaTitle || "";
    $("cfgPayTitle").value = cfg.paySpaTitle || "";
    $("cfgParentField").value = cfg.parentField || "";
    $("cfgPlanTotalField").value = cfg.planTotalField || "";
    $("cfgPlanCourseField").value = cfg.planCourseField || "";
    $("cfgPayAmountField").value = cfg.payAmountField || "";
    $("cfgPayDateField").value = cfg.payDateField || "";
    $("cfgPayCommentField").value = cfg.payCommentField || "";
  }

  async function ensureCourses(){
    courses = await appOptionGet(APP_KEYS.COURSES, DEFAULT_COURSES);
    // Plan modal select
    const sel=$("plCourse");
    sel.innerHTML="";
    for(const c of courses){
      const o=document.createElement("option");
      o.value=c.id;
      o.textContent=c.name;
      sel.appendChild(o);
    }
  }

  function getCourseById(id){
    return (courses||[]).find(x=>x.id===id) || null;
  }

  async function loadPlan(){
    // MVP: Plan SPA ichidan dealId bo‚Äòyicha 1 ta active plan topamiz (eng oxirgisi)
    if(!cfg.planSpaTitle) throw new Error("Settings: Plan SPA title bo‚Äòsh.");
    if(!cfg.parentField) throw new Error("Settings: parentField bo‚Äòsh.");

    if(!planEntityTypeId) planEntityTypeId = await resolveEntityTypeIdByTitle(cfg.planSpaTitle);

    const filter={};
    filter[cfg.parentField]=dealId;

    const items = await bxCallAll("crm.item.list", {
      entityTypeId: planEntityTypeId,
      filter,
      order: { id:"DESC" },
      select: ["id","title", cfg.planTotalField, cfg.planCourseField]
    });

    return items.length ? items[0] : null;
  }

  async function loadPayments(planId){
    // Payment SPA ishlashi uchun cfg.paySpaTitle va payment fieldlar to‚Äòliq bo‚Äòlishi kerak
    if(!cfg.paySpaTitle) return [];
    if(!cfg.payAmountField || !cfg.payDateField) return [];

    if(!payEntityTypeId) payEntityTypeId = await resolveEntityTypeIdByTitle(cfg.paySpaTitle);

    const filter={};
    filter[cfg.parentField]=dealId; // payment ham dealga bog‚Äòlanadi

    const items = await bxCallAll("crm.item.list", {
      entityTypeId: payEntityTypeId,
      filter,
      order: { [cfg.payDateField]:"DESC", id:"DESC" },
      select: ["id","title", cfg.payAmountField, cfg.payDateField, cfg.payCommentField]
    });

    // Agar planId bo‚Äòyicha ajratmoqchi bo‚Äòlsangiz: Payment SPA ga planId field qo‚Äòshib filter qiling
    return items || [];
  }

  function sumPayments(payments){
    let s=0;
    for(const p of payments){
      s += Number(p[cfg.payAmountField] || 0);
    }
    return s;
  }

  function renderPayments(payments){
    const tb=$("payBody");
    tb.innerHTML="";
    $("payCount").textContent = (payments.length||0) + " ta";

    if(!payments.length){
      const tr=document.createElement("tr");
      tr.innerHTML = `<td colspan="4" class="mini">Hali to‚Äòlov yo‚Äòq.</td>`;
      tb.appendChild(tr);
      return;
    }

    for(const p of payments){
      const id=p.id;
      const dt=String(p[cfg.payDateField]||"").substring(0,10) || "‚Äî";
      const amt=Number(p[cfg.payAmountField]||0);
      const cm=cfg.payCommentField ? (p[cfg.payCommentField]||"") : "";

      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>${dt}</td>
        <td><b>${money(amt)}</b></td>
        <td>${String(cm||"")}</td>
        <td>
          <div class="act">
            <button class="linkbtn" data-act="edit" data-id="${id}">‚úèÔ∏è</button>
            <button class="mutebtn danger" data-act="del" data-id="${id}">üóëÔ∏è</button>
          </div>
        </td>
      `;
      tb.appendChild(tr);
    }

    tb.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.onclick = async ()=>{
        const act=btn.getAttribute("data-act");
        const id=btn.getAttribute("data-id");
        if(act==="del") await deletePayment(id);
        if(act==="edit") await editPayment(id);
      };
    });
  }

  async function refreshAll(){
    showErr("");
    status("Loading‚Ä¶");

    $("pillDeal").textContent = "Deal: #" + dealId;

    const plan = await loadPlan();
    if(!plan){
      $("pillPlan").textContent = "Plan: yo‚Äòq";
      $("stCourse").textContent = "‚Äî";
      $("stTotal").textContent = money(0);
      $("stPaid").textContent = money(0);
      $("stRemain").textContent = money(0);
      $("planHint").textContent = "Avval üßÆ orqali plan yarating.";
      renderPayments([]);
      status("Ready");
      return;
    }

    $("pillPlan").textContent = "Plan: #" + plan.id;

    const total = Number(plan[cfg.planTotalField] || 0);

    // Course: agar planCourseField ga kursId yoki nom yozsangiz
    const courseVal = String(plan[cfg.planCourseField] || "");
    const c = getCourseById(courseVal);
    const courseName = c ? c.name : (courseVal || "‚Äî");

    $("stCourse").textContent = courseName;
    $("stTotal").textContent = money(total);

    const payments = await loadPayments(plan.id);
    const paid = sumPayments(payments);
    const remain = Math.max(0, total - paid);

    $("stPaid").textContent = money(paid);
    $("stRemain").textContent = money(remain);
    $("planHint").textContent = (cfg.payAmountField ? "" : "Payment SPA fieldlari settings‚Äôda to‚Äòldirilmagan.");

    renderPayments(payments);

    status("Ready");
  }

  // CRUD: Plan
  async function createPlan(){
    const courseId=$("plCourse").value;
    const course=getCourseById(courseId);
    if(!course) throw new Error("Kurs topilmadi.");

    const price=Number(course.price||0);
    const prepay=parseMoney($("plPrepay").value);
    const months=Number($("plMonths").value||0);
    const firstDate=$("plFirstDate").value;

    if(!months || months<1) throw new Error("Muddat (oy) noto‚Äòg‚Äòri.");
    if(!/^\d{4}-\d{2}-\d{2}$/.test(firstDate)) throw new Error("Birinchi to‚Äòlov sanasi noto‚Äòg‚Äòri.");

    const total=Math.max(0, price - prepay);

    if(!planEntityTypeId) planEntityTypeId = await resolveEntityTypeIdByTitle(cfg.planSpaTitle);

    const fields={};
    fields[cfg.parentField]=dealId;
    fields[cfg.planTotalField]=total;
    fields[cfg.planCourseField]=courseId; // kursId saqlaymiz

    await bxCall("crm.item.add", { entityTypeId: planEntityTypeId, fields });
  }

  async function deletePlan(){
    const plan = await loadPlan();
    if(!plan){ alert("Plan yo‚Äòq."); return; }
    const ok=confirm("Plan‚Äôni o‚Äòchirmoqchimisiz? (Kurs bo‚Äòyicha umumiy rejani o‚Äòchiradi)");
    if(!ok) return;
    if(!planEntityTypeId) planEntityTypeId = await resolveEntityTypeIdByTitle(cfg.planSpaTitle);
    await bxCall("crm.item.delete", { entityTypeId: planEntityTypeId, id: Number(plan.id) });
  }

  // CRUD: Payment
  async function addPayment(){
    if(!cfg.paySpaTitle) throw new Error("Payment SPA title settings‚Äôda yo‚Äòq.");
    if(!cfg.payAmountField || !cfg.payDateField) throw new Error("Payment fieldlar (amount/date) settings‚Äôda to‚Äòldirilmagan.");

    const date=$("payDate").value;
    const amt=parseMoney($("payAmount").value);
    const com=$("payComment").value.trim();

    if(!/^\d{4}-\d{2}-\d{2}$/.test(date)) throw new Error("Sana noto‚Äòg‚Äòri.");
    if(!amt || amt<=0) throw new Error("Summa noto‚Äòg‚Äòri.");

    if(!payEntityTypeId) payEntityTypeId = await resolveEntityTypeIdByTitle(cfg.paySpaTitle);

    const fields={};
    fields[cfg.parentField]=dealId;
    fields[cfg.payAmountField]=amt;
    fields[cfg.payDateField]=date;
    if(cfg.payCommentField) fields[cfg.payCommentField]=com;

    await bxCall("crm.item.add", { entityTypeId: payEntityTypeId, fields });
  }

  async function deletePayment(id){
    const ok=confirm("To‚Äòlovni o‚Äòchirmoqchimisiz?");
    if(!ok) return;
    if(!payEntityTypeId) payEntityTypeId = await resolveEntityTypeIdByTitle(cfg.paySpaTitle);
    await bxCall("crm.item.delete", { entityTypeId: payEntityTypeId, id: Number(id) });
    await refreshAll();
  }

  async function editPayment(id){
    // MVP edit: prompt orqali (xohlasangiz modal qilib beramiz)
    const newAmt = prompt("Yangi summa (so‚Äòm):");
    if(newAmt==null) return;
    const amt=parseMoney(newAmt);
    if(!amt || amt<=0){ alert("Summa noto‚Äòg‚Äòri."); return; }

    const newDate = prompt("Yangi sana (YYYY-MM-DD):");
    if(newDate==null) return;
    if(!/^\d{4}-\d{2}-\d{2}$/.test(newDate)){ alert("Sana noto‚Äòg‚Äòri."); return; }

    if(!payEntityTypeId) payEntityTypeId = await resolveEntityTypeIdByTitle(cfg.paySpaTitle);

    const fields={};
    fields[cfg.payAmountField]=amt;
    fields[cfg.payDateField]=newDate;

    await bxCall("crm.item.update", { entityTypeId: payEntityTypeId, id: Number(id), fields });
    await refreshAll();
  }

  // UI hooks
  function wire(){
    $("btnRefresh").onclick = ()=>refreshAll().catch(e=>showErr(e.message||String(e)));

    $("btnSettings").onclick = ()=>{ $("cfgErr").textContent=""; openMask("mSettings"); };
    $("btnCloseSettings").onclick = ()=>closeMask("mSettings");
    $("btnCancelSettings").onclick = ()=>closeMask("mSettings");

    $("btnSaveSettings").onclick = async ()=>{
      try{
        const s={
          planSpaTitle: $("cfgPlanTitle").value.trim(),
          paySpaTitle: $("cfgPayTitle").value.trim(),
          parentField: $("cfgParentField").value.trim(),
          planTotalField: $("cfgPlanTotalField").value.trim(),
          planCourseField: $("cfgPlanCourseField").value.trim(),
          payAmountField: $("cfgPayAmountField").value.trim(),
          payDateField: $("cfgPayDateField").value.trim(),
          payCommentField: $("cfgPayCommentField").value.trim()
        };
        await appOptionSet(APP_KEYS.SETTINGS, s);
        cfg=s;
        // reset caches
        planEntityTypeId=null;
        payEntityTypeId=null;
        closeMask("mSettings");
        await refreshAll();
      }catch(e){
        $("cfgErr").textContent = e.message||String(e);
      }
    };

    // payment modal
    $("btnPay").onclick = ()=>{
      $("payErr").textContent="";
      $("payDate").value=todayISO();
      $("payAmount").value="";
      $("payComment").value="";
      openMask("mPay");
    };
    $("btnClosePay").onclick = ()=>closeMask("mPay");
    $("btnCancelPay").onclick = ()=>closeMask("mPay");
    $("btnDoPay").onclick = async ()=>{
      try{
        $("payErr").textContent="";
        $("btnDoPay").disabled=true;
        await addPayment();
        closeMask("mPay");
        await refreshAll();
      }catch(e){
        $("payErr").textContent=e.message||String(e);
      }finally{
        $("btnDoPay").disabled=false;
      }
    };

    // plan modal
    $("btnPlan").onclick = ()=>{
      $("plErr").textContent="";
      $("plPrepay").value="";
      $("plMonths").value="6";
      $("plFirstDate").value=todayISO();
      openMask("mPlan");
      updatePlanPreview();
    };
    $("btnClosePlan").onclick = ()=>closeMask("mPlan");
    $("btnCancelPlan").onclick = ()=>closeMask("mPlan");
    $("btnDoPlan").onclick = async ()=>{
      try{
        $("plErr").textContent="";
        $("btnDoPlan").disabled=true;
        await createPlan();
        closeMask("mPlan");
        await refreshAll();
      }catch(e){
        $("plErr").textContent=e.message||String(e);
      }finally{
        $("btnDoPlan").disabled=false;
      }
    };

    $("btnDeletePlan").onclick = async ()=>{
      try{
        await deletePlan();
        await refreshAll();
      }catch(e){
        showErr(e.message||String(e));
      }
    };

    // course change
    $("plCourse").onchange = updatePlanPreview;
    $("plPrepay").oninput = updatePlanPreview;
  }

  function updatePlanPreview(){
    const id=$("plCourse").value;
    const c=getCourseById(id);
    if(!c){ $("plCoursePrice").value=""; $("plRemainPreview").value=""; return; }
    const pre=parseMoney($("plPrepay").value);
    const total=Math.max(0, Number(c.price||0) - pre);
    $("plCoursePrice").value = money(c.price||0);
    $("plRemainPreview").value = money(total);
  }

  // Boot
  (async function boot(){
    const ok = await window.__bxReady;
    if(!ok){
      showErr("BX24 yuklanmadi. Iltimos HTTPS hosting va Bitrix24 iframe‚Äôda ochilayotganini tekshiring.");
      return;
    }

    BX24.init(async function(){
      try{
        status("Init‚Ä¶");
        showErr("");

        dealId = await getDealId();
        if(!dealId){
          showErr("Deal ID olinmadi. Widget faqat Deal ichida ishlaydi.");
          status("");
          return;
        }

        await ensureConfig();
        await ensureCourses();

        wire();
        await refreshAll();

      }catch(e){
        showErr(e.message||String(e));
        status("");
      }
    });
  })();

})();
</script>
</body>
</html>
