<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Muddatli To'lov - Deal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://api.bitrix24.com/api/v1/"></script>
  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --border:#e6e8ee; --text:#111827; --muted:#6b7280;
      --blue:#2563eb; --red:#ef4444; --green:#16a34a; --yellow:#f59e0b;
    }
    body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{padding:14px}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;background:var(--card);border:1px solid var(--border);padding:10px;border-radius:12px}
    .btn{border:1px solid var(--border);background:#fff;padding:7px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--blue);border-color:var(--blue);color:#fff}
    .btn.danger{background:var(--red);border-color:var(--red);color:#fff}
    .status{color:var(--muted);font-size:13px}
    .err{margin-top:10px;color:#b00;white-space:pre-wrap;font-size:13px}
    .grid{margin-top:12px;display:grid;grid-template-columns: 360px 1fr;gap:12px;align-items:start}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .title{font-weight:900;margin:0 0 10px}
    .kv{display:grid;grid-template-columns: 1fr auto;gap:6px 10px;font-size:14px}
    .kv div:nth-child(odd){color:var(--muted)}
    .big{font-size:18px;font-weight:900}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;font-weight:800}
    .pill.green{background:#ecfdf5;border-color:#bbf7d0;color:#166534}
    .pill.yellow{background:#fffbeb;border-color:#fde68a;color:#92400e}
    .pill.red{background:#fef2f2;border-color:#fecaca;color:#991b1b}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .row{background:#fff;border:1px solid var(--border);border-radius:12px}
    .row td{padding:10px}
    .row td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
    .row td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
    .mono{font-variant-numeric:tabular-nums}
    .actions{display:flex;gap:8px;justify-content:flex-end}
    .icon{width:36px;height:34px;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer;font-weight:900}
    .icon.danger{border-color:#fecaca}
    .muted{color:var(--muted);font-size:12px}
    .divider{height:1px;background:var(--border);margin:10px 0}
    /* modal */
    .mask{position:fixed;inset:0;background:rgba(17,24,39,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .modal{width:min(900px,96vw);background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.25)}
    .mhead{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border);font-weight:900}
    .mbody{padding:14px}
    .mfoot{display:flex;justify-content:flex-end;gap:10px;padding:12px 14px;border-top:1px solid var(--border)}
    .fg{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .f label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .f input,.f select{width:100%;box-sizing:border-box;padding:10px 12px;border:1px solid var(--border);border-radius:12px;outline:none}
    .smallErr{color:#b00;white-space:pre-wrap;font-size:13px;margin-top:8px}
    pre{background:#0b1020;color:#e5e7eb;padding:10px;border-radius:12px;overflow:auto}
  </style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <button class="btn" id="btnRefresh">Refresh</button>
    <button class="btn primary" id="btnPay">+ To'lov qabul qilish</button>
    <button class="btn" id="btnPlan">üßÆ Reja (kalkulyator)</button>
    <button class="btn" id="btnSettings">Settings</button>
    <button class="btn danger" id="btnDeleteAll">üóë Kurs rejasini o‚Äòchirish</button>
    <span class="status" id="status"></span>
  </div>

  <div class="err" id="err"></div>

  <div class="grid">
    <div class="card">
      <h3 class="title">Umumiy statistika</h3>
      <div class="kv">
        <div>Kurs</div><div class="big" id="sCourse">‚Äî</div>
        <div>Kurs summasi</div><div class="big mono" id="sTotal">0 so'm</div>
        <div>To'langan</div><div class="big mono" id="sPaid">0 so'm</div>
        <div>Qolgan</div><div class="big mono" id="sRemain">0 so'm</div>
      </div>
      <div class="divider"></div>
      <div class="muted">Eslatma: ‚ÄúTo‚Äòlangan‚Äù ‚Äî Payments SPA‚Äôdan olinadi. ‚ÄúKurs summasi‚Äù ‚Äî reja (schedule) yig‚Äòindisi + oldindan to‚Äòlov bo‚Äòlsa qo‚Äòshiladi.</div>
      <div class="divider"></div>
      <div class="muted" id="debug"></div>
    </div>

    <div class="card">
      <h3 class="title">To‚Äòlovlar rejasi va qabul qilingan to‚Äòlovlar</h3>
      <div class="muted">Reja (schedule) satrlari + qabul qilingan to‚Äòlovlar tarixi pastda ko‚Äòrinadi.</div>

      <h4 style="margin:12px 0 6px">Reja (Schedule)</h4>
      <table class="table" id="tblSchedule"></table>

      <h4 style="margin:16px 0 6px">Qabul qilingan to‚Äòlovlar (Payments)</h4>
      <table class="table" id="tblPayments"></table>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="mask" id="mSettings">
  <div class="modal">
    <div class="mhead">
      <div>Settings (Deal widget)</div>
      <button class="btn" id="xSettings">Close</button>
    </div>
    <div class="mbody">
      <div class="fg">
        <div class="f"><label>Schedule SPA nomi</label><input id="cfgSpaScheduleTitle"></div>
        <div class="f"><label>Payments SPA nomi</label><input id="cfgSpaPaymentsTitle"></div>

        <div class="f"><label>Deal parent field (SPA ichida)</label><input id="cfgParentField"></div>

        <div class="f"><label>Schedule: Due date field</label><input id="cfgDueField"></div>
        <div class="f"><label>Schedule: Amount field</label><input id="cfgAmountField"></div>
        <div class="f"><label>Schedule: Installment field</label><input id="cfgInstField"></div>

        <div class="f"><label>Schedule: STAGE_PENDING</label><input id="cfgStagePending"></div>
        <div class="f"><label>Schedule: STAGE_PAID</label><input id="cfgStagePaid"></div>

        <div class="f"><label>Payments: PAY_DATE field</label><input id="cfgPayDateField"></div>
        <div class="f"><label>Payments: PAY_AMOUNT field</label><input id="cfgPayAmountField"></div>

        <div class="f"><label>Deal field: Course name (ixtiyoriy)</label><input id="cfgDealCourseField" placeholder="UF_CRM_... (bo‚Äòlmasa bo‚Äòsh qoldiring)"></div>
        <div class="f"><label>Voronka check (category id list)</label><input id="cfgAllowedCategories" placeholder="0,1,2 (bo‚Äòsh = hammasi)"></div>
      </div>
      <div class="smallErr" id="settingsErr"></div>
    </div>
    <div class="mfoot">
      <button class="btn" id="cancelSettings">Cancel</button>
      <button class="btn primary" id="saveSettings">Save</button>
    </div>
  </div>
</div>

<!-- PLAN MODAL -->
<div class="mask" id="mPlan">
  <div class="modal">
    <div class="mhead">
      <div>üßÆ Yangi muddatli to‚Äòlov rejasini qo‚Äòshish</div>
      <button class="btn" id="xPlan">Close</button>
    </div>
    <div class="mbody">
      <div class="fg">
        <div class="f">
          <label>Kurs</label>
          <select id="pCourse"></select>
        </div>
        <div class="f">
          <label>Kurs narxi (auto)</label>
          <input id="pPrice" disabled>
        </div>
        <div class="f">
          <label>Oldindan to‚Äòlov</label>
          <input id="pDown" inputmode="numeric" placeholder="0">
        </div>
        <div class="f">
          <label>Muddat (oy) ‚Äî 3,6 yoki qo‚Äòlda</label>
          <input id="pMonths" type="number" min="1" value="6">
        </div>
        <div class="f">
          <label>Birinchi to‚Äòlov sanasi</label>
          <input id="pFirstDate" type="date">
        </div>
        <div class="f">
          <label>Har oy (auto)</label>
          <input id="pPerMonth" disabled>
        </div>
      </div>
      <div class="muted" id="pNote" style="margin-top:8px"></div>
      <div class="smallErr" id="planErr"></div>
    </div>
    <div class="mfoot">
      <button class="btn danger" id="planDeleteExisting">Avvalgi rejani o‚Äòchirib yangisini qo‚Äòshish</button>
      <button class="btn primary" id="planCreate">Rejani yaratish</button>
    </div>
  </div>
</div>

<!-- PAYMENT MODAL -->
<div class="mask" id="mPay">
  <div class="modal">
    <div class="mhead">
      <div>+ To‚Äòlov qabul qilish</div>
      <button class="btn" id="xPay">Close</button>
    </div>
    <div class="mbody">
      <div class="fg">
        <div class="f">
          <label>Reja bo‚Äòyicha (ixtiyoriy)</label>
          <select id="payInstallment">
            <option value="">‚Äî Istalgan to‚Äòlov (manual) ‚Äî</option>
          </select>
        </div>
        <div class="f">
          <label>To‚Äòlov sanasi</label>
          <input id="payDate" type="date">
        </div>
        <div class="f">
          <label>To‚Äòlov summasi</label>
          <input id="payAmount" inputmode="numeric" placeholder="500 000">
        </div>
        <div class="f">
          <label>Izoh (ixtiyoriy)</label>
          <input id="payComment" placeholder="Operator izohi">
        </div>
      </div>
      <div class="muted" style="margin-top:8px">
        Agar ‚ÄúReja bo‚Äòyicha‚Äù tanlasangiz ‚Äî shu oyga tegishli to‚Äòlov sifatida yoziladi. Tanlamasangiz ‚Äî manual payment bo‚Äòladi.
      </div>
      <div class="smallErr" id="payErr"></div>
    </div>
    <div class="mfoot">
      <button class="btn primary" id="paySave">Saqlash</button>
    </div>
  </div>
</div>

<!-- EDIT PAYMENT MODAL -->
<div class="mask" id="mEditPay">
  <div class="modal">
    <div class="mhead">
      <div>‚úèÔ∏è To‚Äòlovni tahrirlash</div>
      <button class="btn" id="xEditPay">Close</button>
    </div>
    <div class="mbody">
      <div class="fg">
        <div class="f"><label>Sana</label><input id="epDate" type="date"></div>
        <div class="f"><label>Summa</label><input id="epAmount" inputmode="numeric"></div>
        <div class="f" style="grid-column:1/-1"><label>Izoh</label><input id="epComment"></div>
      </div>
      <div class="smallErr" id="epErr"></div>
    </div>
    <div class="mfoot">
      <button class="btn danger" id="epDelete">üóë O‚Äòchirish</button>
      <button class="btn primary" id="epSave">Saqlash</button>
    </div>
  </div>
</div>

<script>
(function(){
  // ---------- helpers ----------
  const OPT_KEY = "muddatli_tolov_app_cfg_v1";

  function $(id){ return document.getElementById(id); }
  function show(id){ $(id).style.display="flex"; }
  function hide(id){ $(id).style.display="none"; }
  function setErr(msg){ $("err").textContent = msg ? String(msg) : ""; }
  function setStatus(msg){ $("status").textContent = msg ? String(msg) : ""; }
  function money(n){
    const x = Number(n||0);
    return (isFinite(x)? x:0).toLocaleString("ru-RU") + " so'm";
  }
  function parseMoney(s){
    const t = String(s||"").replace(/[^\d]/g,"");
    return t? Number(t):0;
  }
  function todayISO(){
    const d=new Date();
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }
  function addMonths(iso, k){
    const [y,m,d]=iso.split("-").map(Number);
    const dt=new Date(Date.UTC(y,m-1,d));
    dt.setUTCMonth(dt.getUTCMonth()+k);
    const yy=dt.getUTCFullYear(), mm=String(dt.getUTCMonth()+1).padStart(2,"0"), dd=String(dt.getUTCDate()).padStart(2,"0");
    return `${yy}-${mm}-${dd}`;
  }

  function bxCall(method, params){
    return new Promise((resolve,reject)=>{
      BX24.callMethod(method, params, function(res){
        if(res.error()) return reject(new Error(method+": "+res.error()+" "+(res.error_description()||"")));
        resolve(res.data());
      });
    });
  }
  function bxCallAll(method, params){
    return new Promise((resolve,reject)=>{
      const all=[];
      BX24.callMethod(method, params, function(res){
        if(res.error()) return reject(new Error(method+": "+res.error()+" "+(res.error_description()||"")));
        const data=res.data();
        if(Array.isArray(data)) all.push(...data);
        if(res.more()) res.next(); else resolve(all);
      });
    });
  }

  async function optGet(){
    const v = await bxCall("app.option.get", { option: OPT_KEY });
    if(!v) return null;
    try{ return JSON.parse(v); }catch{ return null; }
  }
  async function optSet(obj){
    await bxCall("app.option.set", { option: OPT_KEY, value: JSON.stringify(obj) });
  }

  // ---------- default cfg (siz berganlari bilan) ----------
  const DEFAULT_CFG = {
    spaScheduleTitle: "MUDDATLI TO'LOV",
    parentField: "parentId2",
    dueField: "UF_CRM_15_1768516812",
    amountField: "UF_CRM_15_1768516945",
    instField: "UF_CRM_15_1768516987",
    stagePending: "DT1058_19:UC_9HOY6X",
    stagePaid: "DT1058_19:SUCCESS",

    // payments SPA (siz yaratib qo‚Äòyasiz)
    spaPaymentsTitle: "QABUL QILINGAN TO'LOVLAR",
    payDateField: "UF_CRM_PAY_DATE",
    payAmountField: "UF_CRM_PAY_AMOUNT",

    // optional: deal course field
    dealCourseField: "",
    allowedCategories: "" // "0,1,2"
  };

  async function loadCfg(){
    const saved = await optGet();
    const cfg = Object.assign({}, DEFAULT_CFG, saved||{});
    return cfg;
  }
  async function saveCfgFromUI(){
    const cfg = {
      spaScheduleTitle: $("cfgSpaScheduleTitle").value.trim(),
      spaPaymentsTitle: $("cfgSpaPaymentsTitle").value.trim(),
      parentField: $("cfgParentField").value.trim(),
      dueField: $("cfgDueField").value.trim(),
      amountField: $("cfgAmountField").value.trim(),
      instField: $("cfgInstField").value.trim(),
      stagePending: $("cfgStagePending").value.trim(),
      stagePaid: $("cfgStagePaid").value.trim(),
      payDateField: $("cfgPayDateField").value.trim(),
      payAmountField: $("cfgPayAmountField").value.trim(),
      dealCourseField: $("cfgDealCourseField").value.trim(),
      allowedCategories: $("cfgAllowedCategories").value.trim()
    };
    await optSet(cfg);
    return cfg;
  }
  function fillSettingsUI(cfg){
    $("cfgSpaScheduleTitle").value = cfg.spaScheduleTitle||"";
    $("cfgSpaPaymentsTitle").value = cfg.spaPaymentsTitle||"";
    $("cfgParentField").value = cfg.parentField||"";
    $("cfgDueField").value = cfg.dueField||"";
    $("cfgAmountField").value = cfg.amountField||"";
    $("cfgInstField").value = cfg.instField||"";
    $("cfgStagePending").value = cfg.stagePending||"";
    $("cfgStagePaid").value = cfg.stagePaid||"";
    $("cfgPayDateField").value = cfg.payDateField||"";
    $("cfgPayAmountField").value = cfg.payAmountField||"";
    $("cfgDealCourseField").value = cfg.dealCourseField||"";
    $("cfgAllowedCategories").value = cfg.allowedCategories||"";
  }

  function validateCfg(cfg){
    const req = ["spaScheduleTitle","spaPaymentsTitle","parentField","dueField","amountField","instField","stagePending","stagePaid","payDateField","payAmountField"];
    for(const k of req){
      if(!cfg[k]) throw new Error("Settings to‚Äòliq emas: "+k+" bo‚Äòsh.");
    }
  }

  async function resolveEntityTypeIdByTitle(title){
    const list = await bxCallAll("crm.type.list", { order:{id:"ASC"} });
    const t = String(title||"").trim().toLowerCase();
    const found = list.find(x => String(x.title||"").trim().toLowerCase()===t);
    if(!found) throw new Error("SPA topilmadi: '"+title+"'. (crm.type.list ichida yo‚Äòq)");
    return found.entityTypeId || found.id;
  }

  async function getPlacementInfo(){
    return await new Promise(resolve => BX24.placement.info(resolve));
  }

  function extractDealId(info){
    const o = (info && info.options) ? info.options : {};
    const id =
      o.ID || o.id || o.ENTITY_ID || o.entityId || o.DEAL_ID ||
      (o.ENTITY && (o.ENTITY.ID || o.ENTITY.id)) ||
      (o.PARAMS && (o.PARAMS.ID || o.PARAMS.id));
    return id ? Number(id) : null;
  }

  async function checkAllowedCategory(cfg, deal){
    if(!cfg.allowedCategories) return true;
    const allowed = cfg.allowedCategories.split(",").map(s=>s.trim()).filter(Boolean);
    if(allowed.length===0) return true;
    const cat = String(deal.CATEGORY_ID ?? deal.categoryId ?? "");
    return allowed.includes(cat);
  }

  // ---------- state ----------
  let cfg, dealId, dealData;
  let etScheduleId=null, etPayId=null;
  let scheduleItems=[], paymentItems=[];
  let editPayId=null;

  // ---------- load data ----------
  async function loadDeal(){
    dealData = await bxCall("crm.deal.get", { id: dealId });
  }

  async function loadSchedule(){
    if(!etScheduleId) etScheduleId = await resolveEntityTypeIdByTitle(cfg.spaScheduleTitle);
    const filter = {}; filter[cfg.parentField]=dealId;

    const items = await bxCallAll("crm.item.list", {
      entityTypeId: etScheduleId,
      filter,
      select: ["id","title","stageId", cfg.dueField, cfg.amountField, cfg.instField]
    });

    items.sort((a,b)=>{
      const da = String(a[cfg.dueField]||"");
      const db = String(b[cfg.dueField]||"");
      return da.localeCompare(db);
    });

    scheduleItems = items;
  }

  async function loadPayments(){
    if(!etPayId) etPayId = await resolveEntityTypeIdByTitle(cfg.spaPaymentsTitle);
    const filter = {}; filter[cfg.parentField]=dealId;

    const items = await bxCallAll("crm.item.list", {
      entityTypeId: etPayId,
      filter,
      select: ["id","title", cfg.payDateField, cfg.payAmountField]
    });

    items.sort((a,b)=>{
      const da = String(a[cfg.payDateField]||"");
      const db = String(b[cfg.payDateField]||"");
      return db.localeCompare(da);
    });

    paymentItems = items;
  }

  function computeTotals(){
    // kurs summasi = schedule amount yig‚Äòindisi
    const total = scheduleItems.reduce((s,it)=> s + Number(it[cfg.amountField]||0), 0);
    // paid = payments yig‚Äòindisi
    const paid  = paymentItems.reduce((s,it)=> s + Number(it[cfg.payAmountField]||0), 0);
    const remain = Math.max(0, total - paid);
    return { total, paid, remain };
  }

  function courseNameFromDeal(){
    if(cfg.dealCourseField && dealData && dealData[cfg.dealCourseField]) return String(dealData[cfg.dealCourseField]);
    // fallback: schedule first title
    return "‚Äî";
  }

  function render(){
    const {total, paid, remain} = computeTotals();
    $("sCourse").textContent = courseNameFromDeal();
    $("sTotal").textContent = money(total);
    $("sPaid").textContent  = money(paid);
    $("sRemain").textContent= money(remain);

    renderScheduleTable();
    renderPaymentsTable();
    fillPayInstallmentsDropdown();

    const dbg = {
      dealId,
      placement: window.__placementName,
      options: window.__placementOptions
    };
    $("debug").innerHTML = "Debug (agar Deal ID muammo bo‚Äòlsa):<br><pre>"+escapeHtml(JSON.stringify(dbg,null,2))+"</pre>";
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function statusPill(it){
    const stage = it.stageId;
    const due = String(it[cfg.dueField]||"").substring(0,10);
    const now = new Date(todayISO()+"T00:00:00");
    const dt  = due? new Date(due+"T00:00:00") : null;

    if(stage === cfg.stagePaid) return `<span class="pill green">PAID</span>`;
    if(!dt) return `<span class="pill yellow">PENDING</span>`;
    const diff = Math.floor((dt-now)/(1000*60*60*24));
    if(diff < 0) return `<span class="pill red">OVERDUE</span>`;
    if(diff <= 1) return `<span class="pill yellow">1 kun qoldi</span>`;
    return `<span class="pill yellow">PENDING</span>`;
  }

  function renderScheduleTable(){
    const t = $("tblSchedule");
    if(scheduleItems.length===0){
      t.innerHTML = `<tr class="row"><td colspan="5" class="muted">Reja topilmadi. üßÆ orqali reja yarating.</td></tr>`;
      return;
    }

    t.innerHTML = scheduleItems.map(it=>{
      const due = String(it[cfg.dueField]||"").substring(0,10) || "‚Äî";
      const amt = money(it[cfg.amountField]||0);
      const inst= String(it[cfg.instField]||it.title||"");
      const pill= statusPill(it);

      return `
        <tr class="row">
          <td class="mono">${due}</td>
          <td>${inst}</td>
          <td class="mono" style="text-align:right;font-weight:900">${amt}</td>
          <td style="text-align:right">${pill}</td>
          <td style="width:140px">
            <div class="actions">
              <button class="icon" title="Paid qilish" onclick="window.__markPaid('${it.id}')">‚úî</button>
              <button class="icon danger" title="Schedule satrini o‚Äòchirish" onclick="window.__delSchedule('${it.id}')">üóë</button>
            </div>
          </td>
        </tr>`;
    }).join("");
  }

  function renderPaymentsTable(){
    const t = $("tblPayments");
    if(paymentItems.length===0){
      t.innerHTML = `<tr class="row"><td colspan="4" class="muted">To‚Äòlovlar hali yo‚Äòq. ‚Äú+ To‚Äòlov qabul qilish‚Äù orqali kiriting.</td></tr>`;
      return;
    }

    t.innerHTML = paymentItems.map(it=>{
      const d = String(it[cfg.payDateField]||"").substring(0,10) || "‚Äî";
      const a = money(it[cfg.payAmountField]||0);
      return `
        <tr class="row">
          <td class="mono">${d}</td>
          <td class="mono" style="text-align:right;font-weight:900">${a}</td>
          <td class="muted">${escapeHtml(it.title||"")}</td>
          <td style="width:120px">
            <div class="actions">
              <button class="icon" title="Tahrirlash" onclick="window.__editPay('${it.id}')">‚úèÔ∏è</button>
              <button class="icon danger" title="O‚Äòchirish" onclick="window.__deletePay('${it.id}')">üóë</button>
            </div>
          </td>
        </tr>`;
    }).join("");
  }

  function fillPayInstallmentsDropdown(){
    const sel = $("payInstallment");
    const prev = sel.value;
    sel.innerHTML = `<option value="">‚Äî Istalgan to‚Äòlov (manual) ‚Äî</option>` + scheduleItems.map(it=>{
      const due = String(it[cfg.dueField]||"").substring(0,10) || "";
      const inst= String(it[cfg.instField]||it.title||"");
      const amt = Number(it[cfg.amountField]||0).toLocaleString("ru-RU");
      return `<option value="${it.id}">${due} | ${inst} | ${amt}</option>`;
    }).join("");
    sel.value = prev;
  }

  // ---------- actions ----------
  async function reloadAll(){
    setErr("");
    setStatus("Loading‚Ä¶");
    await loadDeal();
    const allowed = await checkAllowedCategory(cfg, dealData);
    if(!allowed){
      setStatus("");
      setErr("Bu voronkada widget o‚Äòchirilgan (Settings > Voronkalar).");
      return;
    }
    await loadSchedule();
    await loadPayments();
    render();
    setStatus("Ready");
  }

  async function addPayment(){
    const installmentId = $("payInstallment").value.trim();
    const payDate = $("payDate").value;
    const payAmount = parseMoney($("payAmount").value);
    const comment = $("payComment").value.trim();

    if(!/^\d{4}-\d{2}-\d{2}$/.test(payDate)) throw new Error("To‚Äòlov sanasi noto‚Äòg‚Äòri.");
    if(!payAmount || payAmount<=0) throw new Error("To‚Äòlov summasi noto‚Äòg‚Äòri.");

    if(!etPayId) etPayId = await resolveEntityTypeIdByTitle(cfg.spaPaymentsTitle);

    const fields = {};
    fields[cfg.parentField] = dealId;
    fields[cfg.payDateField] = payDate;
    fields[cfg.payAmountField] = payAmount;

    // title‚Äôga qisqa info yozamiz
    let ttl = "To'lov";
    if(installmentId){
      const it = scheduleItems.find(x=>String(x.id)===String(installmentId));
      ttl = it ? ("Reja: " + (it[cfg.instField]||it.title||"") ) : "Reja bo'yicha";
    }
    if(comment) ttl += " | " + comment;
    fields.title = ttl;

    await bxCall("crm.item.add", { entityTypeId: etPayId, fields });

    // Agar reja bo‚Äòyicha to‚Äòliq yopildi deb belgilamoqchi bo‚Äòlsangiz:
    // bu yerda ‚Äúpaid qilish‚Äù logikasini ham qo‚Äòshish mumkin (masalan, installment amount‚Äôga yetgan bo‚Äòlsa stagePaid qilish).
  }

  async function editPaymentSave(){
    const d = $("epDate").value;
    const a = parseMoney($("epAmount").value);
    const c = $("epComment").value.trim();

    if(!editPayId) throw new Error("Payment tanlanmadi.");
    if(!/^\d{4}-\d{2}-\d{2}$/.test(d)) throw new Error("Sana noto‚Äòg‚Äòri.");
    if(!a || a<=0) throw new Error("Summa noto‚Äòg‚Äòri.");

    if(!etPayId) etPayId = await resolveEntityTypeIdByTitle(cfg.spaPaymentsTitle);

    const fields = {};
    fields[cfg.payDateField] = d;
    fields[cfg.payAmountField] = a;
    fields.title = c ? ("To'lov | "+c) : "To'lov";

    await bxCall("crm.item.update", { entityTypeId: etPayId, id: Number(editPayId), fields });
  }

  async function deletePayment(id){
    if(!confirm("To‚Äòlovni o‚Äòchirasizmi?")) return;
    if(!etPayId) etPayId = await resolveEntityTypeIdByTitle(cfg.spaPaymentsTitle);
    await bxCall("crm.item.delete", { entityTypeId: etPayId, id: Number(id) });
  }

  async function markSchedulePaid(id){
    if(!confirm("Ushbu reja satrini PAID qilishni xohlaysizmi?")) return;
    if(!etScheduleId) etScheduleId = await resolveEntityTypeIdByTitle(cfg.spaScheduleTitle);
    await bxCall("crm.item.update", { entityTypeId: etScheduleId, id: Number(id), fields: { stageId: cfg.stagePaid } });
  }

  async function deleteScheduleItem(id){
    if(!confirm("Reja satrini o‚Äòchirasizmi?")) return;
    if(!etScheduleId) etScheduleId = await resolveEntityTypeIdByTitle(cfg.spaScheduleTitle);
    await bxCall("crm.item.delete", { entityTypeId: etScheduleId, id: Number(id) });
  }

  async function deleteAllPlan(){
    if(!confirm("Butun kurs rejasini o‚Äòchirasizmi? (schedule + payments)")) return;
    setStatus("Deleting‚Ä¶");
    if(!etScheduleId) etScheduleId = await resolveEntityTypeIdByTitle(cfg.spaScheduleTitle);
    if(!etPayId) etPayId = await resolveEntityTypeIdByTitle(cfg.spaPaymentsTitle);

    // schedule delete
    for(const it of scheduleItems){
      await bxCall("crm.item.delete", { entityTypeId: etScheduleId, id: Number(it.id) });
    }
    // payments delete
    for(const it of paymentItems){
      await bxCall("crm.item.delete", { entityTypeId: etPayId, id: Number(it.id) });
    }
  }

  // ---------- plan (calculator) ----------
  let courses = []; // admin paneldan option‚Äôda turadi
  async function loadCoursesFromOptions(){
    // admin panel kurslarni shu option ichida saqlaydi
    const raw = await bxCall("app.option.get", { option: "muddatli_tolov_courses_v1" });
    if(!raw) return [];
    try{
      const arr = JSON.parse(raw);
      return Array.isArray(arr)? arr:[];
    }catch{ return []; }
  }

  function fillCourseSelect(){
    const sel = $("pCourse");
    sel.innerHTML = courses.map(c=>`<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)} (${Number(c.price||0).toLocaleString("ru-RU")})</option>`).join("");
    if(courses.length===0){
      sel.innerHTML = `<option value="">(Kurs yo‚Äòq) Admin panel > Kurslar‚Äôda qo‚Äòshing</option>`;
    }
  }

  function planRecalc(){
    const cId = $("pCourse").value;
    const c = courses.find(x=>String(x.id)===String(cId));
    const price = Number(c?.price||0);
    $("pPrice").value = price ? money(price) : "";
    const down = parseMoney($("pDown").value);
    const months = Number($("pMonths").value||0);
    if(!months || months<1 || !price){
      $("pPerMonth").value="";
      $("pNote").textContent="";
      return;
    }
    const base = Math.max(0, price - down);
    const per = Math.floor(base / months);
    const rem = base - per*months;
    $("pPerMonth").value = money(per);
    $("pNote").textContent = rem ? ("Oxirgi oyga qo‚Äòshimcha: "+money(rem)) : "Bo‚Äòlib to‚Äòlash teng.";
  }

  async function createPlan(deleteExisting){
    const cId = $("pCourse").value;
    const c = courses.find(x=>String(x.id)===String(cId));
    if(!c) throw new Error("Kurs tanlanmadi (Admin panel > Kurslar).");

    const price = Number(c.price||0);
    const down = parseMoney($("pDown").value);
    const months = Number($("pMonths").value||0);
    const first = $("pFirstDate").value;

    if(!price) throw new Error("Kurs narxi 0 bo‚Äòlmasin.");
    if(!months || months<1) throw new Error("Muddat noto‚Äòg‚Äòri.");
    if(!/^\d{4}-\d{2}-\d{2}$/.test(first)) throw new Error("Birinchi to‚Äòlov sanasi noto‚Äòg‚Äòri.");

    if(!etScheduleId) etScheduleId = await resolveEntityTypeIdByTitle(cfg.spaScheduleTitle);

    // avvalgi rejani o‚Äòchirish (ixtiyoriy)
    if(deleteExisting){
      await loadSchedule();
      for(const it of scheduleItems){
        await bxCall("crm.item.delete", { entityTypeId: etScheduleId, id: Number(it.id) });
      }
    }

    // down payment bo‚Äòlsa ‚Äî payments SPA ga yozib qo‚Äòyamiz
    if(down>0){
      if(!etPayId) etPayId = await resolveEntityTypeIdByTitle(cfg.spaPaymentsTitle);
      const pf={};
      pf[cfg.parentField]=dealId;
      pf[cfg.payDateField]=todayISO();
      pf[cfg.payAmountField]=down;
      pf.title = "Oldindan to'lov | "+c.name;
      await bxCall("crm.item.add", { entityTypeId: etPayId, fields: pf });
    }

    // schedule yaratish
    const base = Math.max(0, price - down);
    const per = Math.floor(base / months);
    const rem = base - per*months;

    for(let i=1;i<=months;i++){
      const due = addMonths(first, i-1);
      const amt = per + (i===months ? rem : 0);
      const inst = `${i}/${months}`;

      const f={};
      f[cfg.parentField]=dealId;
      f[cfg.dueField]=due;
      f[cfg.amountField]=amt;
      f[cfg.instField]=inst;
      f.stageId = cfg.stagePending;
      f.title = c.name;

      await bxCall("crm.item.add", { entityTypeId: etScheduleId, fields: f });
    }

    // Deal field kurs nomi bo‚Äòlsa yozamiz
    if(cfg.dealCourseField){
      const df={}; df[cfg.dealCourseField]=c.name;
      await bxCall("crm.deal.update", { id: dealId, fields: df });
    }
  }

  // ---------- boot ----------
  BX24.init(async function(){
    try{
      setErr("");
      setStatus("Init‚Ä¶");

      cfg = await loadCfg();
      validateCfg(cfg);

      const info = await getPlacementInfo();
      window.__placementName = info?.placement || "";
      window.__placementOptions = info?.options || {};

      dealId = extractDealId(info);
      if(!dealId){
        // foydalanuvchiga aniq ko‚Äòrsatamiz (sizda adashish bo‚Äòlmasligi uchun)
        throw new Error(
          "Deal ID olinmadi.\n" +
          "1) App CRM Deal ichidagi TAB (CRM_DEAL_DETAIL_TAB) sifatida o‚Äòrnatilganini tekshiring.\n" +
          "2) install.html placement.bind to‚Äòg‚Äòri ishlagan bo‚Äòlishi kerak.\n\n" +
          "Debug options:\n" + JSON.stringify(info?.options||{}, null, 2)
        );
      }

      // UI wiring
      $("btnRefresh").onclick = ()=>reloadAll().catch(e=>setErr(e.message||String(e)));
      $("btnSettings").onclick = async ()=>{
        $("settingsErr").textContent="";
        fillSettingsUI(await loadCfg());
        show("mSettings");
      };
      $("xSettings").onclick = ()=>hide("mSettings");
      $("cancelSettings").onclick = ()=>hide("mSettings");
      $("saveSettings").onclick = async ()=>{
        try{
          $("settingsErr").textContent="";
          const newCfg = await saveCfgFromUI();
          cfg = Object.assign(cfg, newCfg);
          validateCfg(cfg);
          etScheduleId=null; etPayId=null;
          hide("mSettings");
          await reloadAll();
        }catch(e){ $("settingsErr").textContent = e.message||String(e); }
      };

      $("btnPlan").onclick = async ()=>{
        $("planErr").textContent="";
        $("pFirstDate").value = todayISO();
        $("pDown").value="";
        $("pMonths").value="6";
        courses = await loadCoursesFromOptions();
        fillCourseSelect();
        planRecalc();
        show("mPlan");
      };
      $("xPlan").onclick = ()=>hide("mPlan");
      $("pCourse").onchange = planRecalc;
      $("pDown").oninput = ()=>{ $("pDown").value = parseMoney($("pDown").value).toLocaleString("ru-RU"); planRecalc(); };
      $("pMonths").oninput = planRecalc;
      $("planCreate").onclick = async ()=>{
        try{
          $("planErr").textContent="";
          setStatus("Creating plan‚Ä¶");
          await createPlan(false);
          hide("mPlan");
          await reloadAll();
        }catch(e){ $("planErr").textContent=e.message||String(e); setStatus(""); }
      };
      $("planDeleteExisting").onclick = async ()=>{
        try{
          if(!confirm("Avvalgi reja o‚Äòchadi. Davom etamizmi?")) return;
          $("planErr").textContent="";
          setStatus("Recreating plan‚Ä¶");
          await createPlan(true);
          hide("mPlan");
          await reloadAll();
        }catch(e){ $("planErr").textContent=e.message||String(e); setStatus(""); }
      };

      $("btnPay").onclick = ()=>{
        $("payErr").textContent="";
        $("payDate").value=todayISO();
        $("payAmount").value="";
        $("payComment").value="";
        show("mPay");
      };
      $("xPay").onclick = ()=>hide("mPay");
      $("paySave").onclick = async ()=>{
        try{
          $("payErr").textContent="";
          setStatus("Saving payment‚Ä¶");
          await addPayment();
          hide("mPay");
          await reloadAll();
        }catch(e){ $("payErr").textContent=e.message||String(e); setStatus(""); }
      };

      $("btnDeleteAll").onclick = async ()=>{
        try{
          await deleteAllPlan();
          await reloadAll();
        }catch(e){ setErr(e.message||String(e)); setStatus(""); }
      };

      // edit payment modal
      $("xEditPay").onclick = ()=>hide("mEditPay");
      $("epSave").onclick = async ()=>{
        try{
          $("epErr").textContent="";
          setStatus("Updating‚Ä¶");
          await editPaymentSave();
          hide("mEditPay");
          await reloadAll();
        }catch(e){ $("epErr").textContent=e.message||String(e); setStatus(""); }
      };
      $("epDelete").onclick = async ()=>{
        try{
          if(!editPayId) return;
          await deletePayment(editPayId);
          hide("mEditPay");
          await reloadAll();
        }catch(e){ $("epErr").textContent=e.message||String(e); setStatus(""); }
      };

      // expose for inline buttons
      window.__markPaid = (id)=>markSchedulePaid(id).then(reloadAll).catch(e=>setErr(e.message||String(e)));
      window.__delSchedule = (id)=>deleteScheduleItem(id).then(reloadAll).catch(e=>setErr(e.message||String(e)));
      window.__deletePay = (id)=>deletePayment(id).then(reloadAll).catch(e=>setErr(e.message||String(e)));
      window.__editPay = (id)=>{
        const it = paymentItems.find(x=>String(x.id)===String(id));
        if(!it) return;
        editPayId = id;
        $("epErr").textContent="";
        $("epDate").value = String(it[cfg.payDateField]||"").substring(0,10) || todayISO();
        $("epAmount").value = Number(it[cfg.payAmountField]||0).toLocaleString("ru-RU");
        $("epComment").value = String(it.title||"").replace(/^To'lov\s*\|\s*/,"");
        show("mEditPay");
      };

      await reloadAll();

    }catch(e){
      setStatus("");
      setErr(e.message||String(e));
    }
  });
})();
</script>
</body>
</html>
