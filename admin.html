<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Muddatli To'lov - Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://api.bitrix24.com/api/v1/"></script>
  <style>
    :root{--bg:#0b1220;--card:#0f172a;--border:#1f2a44;--text:#e5e7eb;--muted:#94a3b8;--blue:#2563eb}
    body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    .side{padding:14px;border-right:1px solid var(--border);background:rgba(15,23,42,.75)}
    .brand{font-weight:900;font-size:16px;margin-bottom:10px}
    .sub{color:var(--muted);font-size:12px;margin-bottom:14px}
    .nav{display:flex;flex-direction:column;gap:8px}
    .nav button{width:100%;text-align:left;border:1px solid var(--border);background:transparent;color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:800}
    .nav button.active{background:var(--blue);border-color:var(--blue)}
    .main{padding:16px}
    .card{background:#fff;color:#111827;border-radius:14px;padding:14px}
    h2{margin:0 0 10px}
    .muted{color:#6b7280;font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end;margin:10px 0}
    .f{display:flex;flex-direction:column;gap:6px}
    .f label{font-size:12px;color:#6b7280}
    .f input,.f select, textarea{padding:10px 12px;border:1px solid #e6e8ee;border-radius:12px;min-width:220px}
    textarea{min-width:420px;min-height:90px}
    .btn{border:1px solid #e6e8ee;background:#fff;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:900}
    .btn.primary{background:var(--blue);border-color:var(--blue);color:#fff}
    .btn.danger{background:#ef4444;border-color:#ef4444;color:#fff}
    table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:10px}
    tr{background:#f9fafb}
    td{padding:10px;border-top:1px solid #e6e8ee;border-bottom:1px solid #e6e8ee}
    td:first-child{border-left:1px solid #e6e8ee;border-top-left-radius:12px;border-bottom-left-radius:12px}
    td:last-child{border-right:1px solid #e6e8ee;border-top-right-radius:12px;border-bottom-right-radius:12px}
    .err{color:#b00;white-space:pre-wrap;font-size:13px;margin-top:10px}
  </style>
</head>
<body>
<div class="wrap">
  <aside class="side">
    <div class="brand">Admin Panel</div>
    <div class="sub">Muddatli to‚Äòlov sozlamalari</div>
    <div class="nav">
      <button data-tab="courses" class="active">Kurslar</button>
      <button data-tab="acl">Ruxsatlar</button>
      <button data-tab="funnels">Voronkalar</button>
      <button data-tab="stats">Statistika</button>
      <button data-tab="settings">Sozlamalar</button>
    </div>
  </aside>

  <main class="main">
    <div class="card">
      <div id="content"></div>
      <div class="err" id="err"></div>
    </div>
  </main>
</div>

<script>
(function(){
  const KEY_COURSES="muddatli_tolov_courses_v1";
  const KEY_ACL="muddatli_tolov_acl_v1";
  const KEY_FUNNELS="muddatli_tolov_funnels_v1";
  const KEY_CFG="muddatli_tolov_app_cfg_v1";

  function $(sel){ return document.querySelector(sel); }
  function setErr(msg){ $("#err").textContent = msg? String(msg):""; }

  function bxCall(method, params){
    return new Promise((resolve,reject)=>{
      BX24.callMethod(method, params, function(res){
        if(res.error()) return reject(new Error(method+": "+res.error()+" "+(res.error_description()||"")));
        resolve(res.data());
      });
    });
  }

  async function optGet(key){
    const v = await bxCall("app.option.get", { option: key });
    if(!v) return null;
    try{ return JSON.parse(v); }catch{ return null; }
  }
  async function optSet(key, obj){
    await bxCall("app.option.set", { option: key, value: JSON.stringify(obj) });
  }

  // --------- tabs render ----------
  async function renderCourses(){
    const data = (await optGet(KEY_COURSES)) || [];
    const html = `
      <h2>Kurslar</h2>
      <div class="muted">Kurs nomi, narxi, muddat (3/6/custom) sozlanadi. Deal ichidagi üßÆ kalkulyator shu ro‚Äòyxatdan oladi.</div>

      <div class="row">
        <div class="f"><label>ID (unique)</label><input id="cId" placeholder="course_1"></div>
        <div class="f"><label>Nomi</label><input id="cName" placeholder="IELTS"></div>
        <div class="f"><label>Narxi</label><input id="cPrice" inputmode="numeric" placeholder="10000000"></div>
        <div class="f"><label>Muddatlar (oy) </label><input id="cMonths" placeholder="3,6,12"></div>
        <button class="btn primary" id="cAdd">Qo‚Äòshish</button>
      </div>

      <table>
        <tr><td style="font-weight:900">ID</td><td style="font-weight:900">Nomi</td><td style="font-weight:900">Narxi</td><td style="font-weight:900">Muddatlar</td><td></td></tr>
        ${data.map(c=>`
          <tr>
            <td>${escapeHtml(c.id||"")}</td>
            <td>${escapeHtml(c.name||"")}</td>
            <td>${Number(c.price||0).toLocaleString("ru-RU")}</td>
            <td>${escapeHtml((c.months||[]).join(","))}</td>
            <td><button class="btn danger" onclick="window.__delCourse('${escapeHtml(c.id||"")}')">O‚Äòchirish</button></td>
          </tr>
        `).join("")}
      </table>
    `;
    $("#content").innerHTML = html;

    $("#cAdd").onclick = async ()=>{
      try{
        setErr("");
        const id = $("#cId").value.trim();
        const name = $("#cName").value.trim();
        const price = Number(String($("#cPrice").value||"").replace(/[^\d]/g,"")||0);
        const months = $("#cMonths").value.split(",").map(s=>Number(s.trim())).filter(x=>x>0);

        if(!id || !name || !price) throw new Error("ID, Nomi, Narxi to‚Äòldirilishi shart.");
        const arr = (await optGet(KEY_COURSES)) || [];
        if(arr.some(x=>String(x.id)===String(id))) throw new Error("Bu ID mavjud. Boshqa ID bering.");

        arr.push({id,name,price,months});
        await optSet(KEY_COURSES, arr);
        await renderCourses();
      }catch(e){ setErr(e.message||String(e)); }
    };

    window.__delCourse = async (id)=>{
      try{
        if(!confirm("Kursni o‚Äòchirasizmi?")) return;
        const arr = (await optGet(KEY_COURSES)) || [];
        const n = arr.filter(x=>String(x.id)!==String(id));
        await optSet(KEY_COURSES, n);
        await renderCourses();
      }catch(e){ setErr(e.message||String(e)); }
    };
  }

  async function renderACL(){
    const data = (await optGet(KEY_ACL)) || {
      canAdd:[], canEdit:[], canDelete:[], canSeeAll:[]
    };
    $("#content").innerHTML = `
      <h2>Ruxsatlar</h2>
      <div class="muted">User ID larni vergul bilan kiriting. (Bitrix user ID: /company/personal/user/#/ )</div>

      <div class="row">
        <div class="f"><label>Qo‚Äòsha oladi (canAdd)</label><textarea id="aAdd"></textarea></div>
        <div class="f"><label>Tahrirlay oladi (canEdit)</label><textarea id="aEdit"></textarea></div>
      </div>
      <div class="row">
        <div class="f"><label>O‚Äòchira oladi (canDelete)</label><textarea id="aDel"></textarea></div>
        <div class="f"><label>Boshqaning to‚Äòlovini ko‚Äòradi (canSeeAll)</label><textarea id="aAll"></textarea></div>
      </div>

      <button class="btn primary" id="aSave">Saqlash</button>
    `;

    function join(v){ return Array.isArray(v)? v.join(", "):""; }
    $("#aAdd").value = join(data.canAdd);
    $("#aEdit").value = join(data.canEdit);
    $("#aDel").value = join(data.canDelete);
    $("#aAll").value = join(data.canSeeAll);

    $("#aSave").onclick = async ()=>{
      try{
        setErr("");
        const parse = (s)=> String(s||"").split(",").map(x=>x.trim()).filter(Boolean).map(Number).filter(x=>x>0);
        const out = {
          canAdd: parse($("#aAdd").value),
          canEdit: parse($("#aEdit").value),
          canDelete: parse($("#aDel").value),
          canSeeAll: parse($("#aAll").value)
        };
        await optSet(KEY_ACL, out);
        alert("Saqlangan.");
      }catch(e){ setErr(e.message||String(e)); }
    };
  }

  async function renderFunnels(){
    const data = (await optGet(KEY_FUNNELS)) || { allowedCategories: "" };
    $("#content").innerHTML = `
      <h2>Voronkalar</h2>
      <div class="muted">Qaysi Deal voronkalarda widget ishlashini belgilang. CATEGORY_ID larni yozing (misol: 0,1,2).</div>
      <div class="row">
        <div class="f"><label>Allowed CATEGORY_ID list</label><input id="fCats" placeholder="0,1,2"></div>
        <button class="btn primary" id="fSave">Saqlash</button>
      </div>
    `;
    $("#fCats").value = data.allowedCategories || "";
    $("#fSave").onclick = async ()=>{
      try{
        setErr("");
        await optSet(KEY_FUNNELS, { allowedCategories: $("#fCats").value.trim() });
        alert("Saqlangan. Deal widget Settings ichida ham shu qiymat ko‚Äòrinadi.");
      }catch(e){ setErr(e.message||String(e)); }
    };
  }

  async function renderStats(){
    $("#content").innerHTML = `
      <h2>Statistika</h2>
      <div class="muted">
        Bu bo‚Äòlimni to‚Äòliq (TOP qarzdorlar, TOP undiruvchilar, kurs bo‚Äòyicha kesimlar) qilish uchun:
        1) Schedule SPA (reja) + Payments SPA (to‚Äòlovlar) aniq ishlashi kerak.
        2) Voronkalar va Kurslar ro‚Äòyxati to‚Äòldirilgan bo‚Äòlishi kerak.
      </div>
      <div style="margin-top:10px" class="muted">
        Tavsiya: bu statistikani server-side (cron) yoki Bitrix BI orqali kengaytirish mumkin.
        Hozirgi versiyada admin panel faqat konfiguratsiyani boshqaradi.
      </div>
    `;
  }

  async function renderSettings(){
    const cfg = (await optGet(KEY_CFG)) || {};
    $("#content").innerHTML = `
      <h2>Sozlamalar</h2>
      <div class="muted">Deal widget (deal.html) ishlashi uchun global konfiguratsiya.</div>
      <pre>${escapeHtml(JSON.stringify(cfg,null,2))}</pre>
      <div class="muted">Sozlamalarni Deal widget ichidagi ‚ÄúSettings‚Äù tugmasidan boshqaring (saqlansa shu yerda ham yangilanadi).</div>
    `;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // --------- navigation ----------
  async function openTab(tab){
    setErr("");
    const btns = document.querySelectorAll(".nav button");
    btns.forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));
    if(tab==="courses") return renderCourses();
    if(tab==="acl") return renderACL();
    if(tab==="funnels") return renderFunnels();
    if(tab==="stats") return renderStats();
    if(tab==="settings") return renderSettings();
  }

  BX24.init(async function(){
    try{
      // menu click
      document.querySelectorAll(".nav button").forEach(b=>{
        b.onclick = ()=>openTab(b.dataset.tab);
      });
      await openTab("courses");
    }catch(e){ setErr(e.message||String(e)); }
  });
})();
</script>
</body>
</html>
