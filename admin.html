<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Muddatli To'lov - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://api.bitrix24.com/api/v1/"></script>
  <style>
    :root{--bg:#f6f7f9;--card:#fff;--border:#e6e8ee;--text:#111827;--muted:#6b7280;--blue:#2563eb;--red:#ef4444}
    body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{padding:14px}
    .grid{display:grid;grid-template-columns:260px 1fr;gap:12px;align-items:start}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .h{font-weight:900;margin:0 0 10px}
    .menu button{width:100%;text-align:left;padding:10px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer;font-weight:800;margin-bottom:8px}
    .menu button.active{border-color:var(--blue);color:var(--blue)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{border:1px solid var(--border);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:800}
    .btn.primary{background:var(--blue);border-color:var(--blue);color:#fff}
    .err{color:#b00;white-space:pre-wrap}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left}
    th{color:var(--muted);font-size:12px}
    input{padding:10px 12px;border:1px solid var(--border);border-radius:10px;outline:none;width:100%;box-sizing:border-box}
    .note{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="grid">
    <div class="card menu">
      <h3 class="h">Admin panel</h3>
      <button id="mCourses" class="active">Kurslar</button>
      <button id="mPerms">Ruxsatlar</button>
      <button id="mPipes">Voronkalar</button>
      <button id="mStats">Statistika</button>
      <button id="mApp">App sozlamalari</button>
      <div class="note">Sozlamalar portal bo‘yicha saqlanadi.</div>
    </div>

    <div class="card">
      <h3 class="h" id="title">Kurslar</h3>
      <div id="content"></div>
      <div class="err" id="err"></div>
    </div>
  </div>
</div>

<script>
(function(){
  const APP_KEYS={ SETTINGS:"mt_settings_v1", COURSES:"mt_courses_v1", PERMS:"mt_perms_v1", PIPES:"mt_pipes_v1" };
  const $=id=>document.getElementById(id);
  const err=(m)=>$("err").textContent=m?String(m):"";

  function appOptionGet(key, fallback){
    return new Promise((resolve)=>{
      BX24.appOption.get(key, function(value){
        if(value==null || value===""){ resolve(fallback); return; }
        try{ resolve(JSON.parse(value)); }catch(e){ resolve(fallback); }
      });
    });
  }
  function appOptionSet(key, obj){
    return new Promise((resolve,reject)=>{
      BX24.appOption.set(key, JSON.stringify(obj), function(res){
        if(res && res.error && res.error()){ reject(new Error(res.error())); return; }
        resolve(true);
      });
    });
  }

  const DEFAULT_COURSES=[
    { id:"course1", name:"Kurs 1", price:1000000, terms:[3,6,12] },
    { id:"course2", name:"Kurs 2", price:2000000, terms:[3,6] }
  ];
  const DEFAULT_PERMS={
    // MVP: role-based
    // admin: full
    // operator: add/edit own, view own
    roles:{
      admin:{ viewAll:true, add:true, edit:true, del:true },
      operator:{ viewAll:false, add:true, edit:true, del:false }
    }
  };
  const DEFAULT_PIPES={ enabledCategoryIds:[] };

  async function renderCourses(){
    $("title").textContent="Kurslar";
    const courses = await appOptionGet(APP_KEYS.COURSES, DEFAULT_COURSES);

    const html = `
      <div class="row" style="justify-content:space-between;margin-bottom:10px">
        <div class="note">Kurs tanlanganda narx va ruxsat etilgan muddatlar avtomatik chiqadi.</div>
        <button class="btn primary" id="add">+ Kurs qo‘shish</button>
      </div>
      <table>
        <thead><tr><th>ID</th><th>Nomi</th><th>Narx</th><th>Muddatlar (oy)</th><th>Amal</th></tr></thead>
        <tbody>
          ${courses.map(c=>`
            <tr>
              <td>${c.id}</td>
              <td>${c.name}</td>
              <td>${Number(c.price||0).toLocaleString("ru-RU")}</td>
              <td>${(c.terms||[]).join(", ")}</td>
              <td><button class="btn" data-edit="${c.id}">Edit</button></td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
    $("content").innerHTML=html;

    $("add").onclick = async ()=>{
      try{
        err("");
        const id = prompt("Kurs ID (unique):"); if(!id) return;
        const name = prompt("Kurs nomi:"); if(!name) return;
        const price = Number((prompt("Narx (so‘m):")||"").replace(/[^\d]/g,""));
        const terms = (prompt("Muddatlar (oy), masalan: 3,6,12")||"").split(",").map(x=>Number(x.trim())).filter(Boolean);
        courses.push({ id, name, price, terms });
        await appOptionSet(APP_KEYS.COURSES, courses);
        await renderCourses();
      }catch(e){ err(e.message||String(e)); }
    };

    document.querySelectorAll("button[data-edit]").forEach(b=>{
      b.onclick = async ()=>{
        try{
          err("");
          const id=b.getAttribute("data-edit");
          const c=courses.find(x=>x.id===id);
          if(!c) return;
          const name=prompt("Nomi:", c.name); if(name==null) return;
          const price=Number((prompt("Narx:", String(c.price||0))||"").replace(/[^\d]/g,""));
          const terms=(prompt("Muddatlar:", (c.terms||[]).join(","))||"").split(",").map(x=>Number(x.trim())).filter(Boolean);
          c.name=name; c.price=price; c.terms=terms;
          await appOptionSet(APP_KEYS.COURSES, courses);
          await renderCourses();
        }catch(e){ err(e.message||String(e)); }
      };
    });
  }

  async function renderPerms(){
    $("title").textContent="Ruxsatlar";
    const perms = await appOptionGet(APP_KEYS.PERMS, DEFAULT_PERMS);

    $("content").innerHTML = `
      <div class="note" style="margin-bottom:10px">
        MVP: role-based ruxsat. Keyin user/group bo‘yicha ham kengaytiramiz.
      </div>
      <table>
        <thead><tr><th>Role</th><th>viewAll</th><th>add</th><th>edit</th><th>del</th></tr></thead>
        <tbody>
          ${Object.entries(perms.roles||{}).map(([r,v])=>`
            <tr>
              <td><b>${r}</b></td>
              <td>${v.viewAll}</td>
              <td>${v.add}</td>
              <td>${v.edit}</td>
              <td>${v.del}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="save">Edit (prompt)</button>
      </div>
    `;

    $("save").onclick = async ()=>{
      try{
        err("");
        const role = prompt("Qaysi role? (admin/operator)"); if(!role) return;
        const cur = perms.roles[role] || { viewAll:false, add:false, edit:false, del:false };
        const viewAll = confirm("viewAll bo‘lsinmi? (OK=ha)");
        const add = confirm("add bo‘lsinmi?");
        const edit = confirm("edit bo‘lsinmi?");
        const del = confirm("del bo‘lsinmi?");
        perms.roles[role] = { viewAll, add, edit, del };
        await appOptionSet(APP_KEYS.PERMS, perms);
        await renderPerms();
      }catch(e){ err(e.message||String(e)); }
    };
  }

  async function renderPipes(){
    $("title").textContent="Voronkalar";
    const pipes = await appOptionGet(APP_KEYS.PIPES, DEFAULT_PIPES);

    // pipeline/category list
    const cats = await new Promise((resolve,reject)=>{
      BX24.callMethod("crm.dealcategory.list", {}, function(res){
        if(res.error()){ reject(new Error(res.error())); return; }
        resolve(res.data()||[]);
      });
    });

    $("content").innerHTML = `
      <div class="note" style="margin-bottom:10px">
        Qaysi voronkada widget ko‘rinsin? Category ID larini belgilang.
      </div>
      <table>
        <thead><tr><th>Enable</th><th>Category ID</th><th>Name</th></tr></thead>
        <tbody>
          ${cats.map(c=>{
            const checked = (pipes.enabledCategoryIds||[]).includes(Number(c.ID));
            return `
              <tr>
                <td><input type="checkbox" data-cat="${c.ID}" ${checked?"checked":""}></td>
                <td>${c.ID}</td>
                <td>${c.NAME}</td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="saveP">Save</button>
      </div>
    `;

    $("saveP").onclick = async ()=>{
      try{
        err("");
        const ids=[];
        document.querySelectorAll("input[data-cat]").forEach(ch=>{
          if(ch.checked) ids.push(Number(ch.getAttribute("data-cat")));
        });
        pipes.enabledCategoryIds = ids;
        await appOptionSet(APP_KEYS.PIPES, pipes);
        alert("Saved.");
      }catch(e){ err(e.message||String(e)); }
    };
  }

  async function renderStats(){
    $("title").textContent="Statistika (MVP)";
    $("content").innerHTML = `
      <div class="note">
        Bu bo‘limni keyin kengaytiramiz:
        - qancha sotuv bo‘ldi
        - qancha tushum bo‘ldi
        - qancha tushum bo‘lishi kerak
        - umumiy qarz
        - TOP qarzdorlar, TOP undiruvchilar
      </div>
      <div style="margin-top:10px" class="note">
        Hozirgi MVP’da statistikani Deal ichidagi widget hisoblaydi. Global statistikaga o‘tish uchun Payment SPA fieldlari va course mapping kerak bo‘ladi.
      </div>
    `;
  }

  async function renderApp(){
    $("title").textContent="App sozlamalari";
    const s = await appOptionGet(APP_KEYS.SETTINGS, {});
    $("content").innerHTML = `
      <div class="note">Bu sozlamalar Deal widget’dagi Settings bilan bir xil.</div>
      <pre style="white-space:pre-wrap;border:1px solid var(--border);border-radius:10px;padding:10px;background:#fff">${JSON.stringify(s,null,2)}</pre>
    `;
  }

  function setActive(btnId){
    ["mCourses","mPerms","mPipes","mStats","mApp"].forEach(id=>{
      $(id).classList.toggle("active", id===btnId);
    });
  }

  BX24.init(async function(){
    try{
      err("");
      $("mCourses").onclick = async ()=>{ setActive("mCourses"); await renderCourses(); };
      $("mPerms").onclick = async ()=>{ setActive("mPerms"); await renderPerms(); };
      $("mPipes").onclick = async ()=>{ setActive("mPipes"); await renderPipes(); };
      $("mStats").onclick = async ()=>{ setActive("mStats"); await renderStats(); };
      $("mApp").onclick = async ()=>{ setActive("mApp"); await renderApp(); };

      await renderCourses();
    }catch(e){
      err(e.message||String(e));
    }
  });
})();
</script>
</body>
</html>
